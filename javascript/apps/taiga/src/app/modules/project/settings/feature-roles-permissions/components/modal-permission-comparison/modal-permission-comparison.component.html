<!--
This Source Code Form is subject to the terms of the Mozilla Public
License, v. 2.0. If a copy of the MPL was not distributed with this
file, You can obtain one at http://mozilla.org/MPL/2.0/.

Copyright (c) 2021-present Kaleidos Ventures SL
-->

<ng-container *transloco="let t">
  <div
    data-test="conflicts-permission-modal"
    aria-describedby="permission-table"
    aria-labeledby="permissions-comparison"
    class="modal-wrapper">
    <h2 id="permissions-comparison" class="modal-title" tabindex="0">
      {{
        t('project_settings.modal_permissions.potential_permission_conflicts')
      }}
    </h2>
    <div id="permission-table" class="permission-table">
      <p
        class="explanation"
        [innerHtml]="
          t(
            'project_settings.modal_permissions.potential_permission_conflicts_explanation'
          )
        "></p>
      <ng-container
        *ngFor="let module of conflictPermissions; trackBy: trackByIndex">
        <h3 class="table-title">
          {{
            t('project_settings.modal_permissions.role', {
              name: module.name
            })
          }}
        </h3>
        <table
          data-test="comparisson-table"
          class="comparisson-table"
          [ngClass]="{ last: last }"
          *ngFor="
            let conflict of module.conflicts;
            let last = last;
            index as i;
            trackBy: trackByIndex
          ">
          <thead *ngIf="i === 0">
            <tr>
              <th aria-hidden="true"></th>
              <th scope="col" class="title">{{ module.name }}</th>
              <th scope="col" class="title">
                {{ t('project_settings.modal_permissions.public') }}
              </th>
            </tr>
          </thead>
          <tbody>
            <tr
              *ngFor="
                let text of conflict.texts.member.text;
                index as idx;
                trackBy: trackByIndex
              ">
              <th
                *ngIf="idx === 0"
                scope="row"
                class="title"
                [attr.rowspan]="conflict.texts.member.text.length">
                {{ t(modules.get(conflict.name)!) }}
              </th>
              <td
                *ngIf="
                  isRestricted(text) &&
                    conflict.texts.member.restrictions?.length;
                  else member
                ">
                <button
                  class="restrictions-btn"
                  [attr.aria-expanded]="
                    dropdown[
                      getParam(conflict.name, module.name, 'member', idx)
                    ]
                  "
                  [attr.aria-controls]="
                    getParam(conflict.name, module.name, 'member', idx)
                  "
                  data-test="member-restrictions-btn"
                  type="button"
                  (click)="
                    handleDropdown(
                      getParam(conflict.name, module.name, 'member', idx)
                    )
                  ">
                  <span
                    class="text highlight"
                    [innerHtml]="t(text)"
                    data-test="member-conflict"></span>
                  <tui-svg
                    class="chevron"
                    [src]="
                      dropdown[
                        getParam(conflict.name, module.name, 'member', idx)
                      ]
                        ? 'chevron-up'
                        : 'chevron-down'
                    ">
                  </tui-svg>
                </button>

                <ul
                  *ngIf="
                    dropdown[
                      getParam(conflict.name, module.name, 'member', idx)
                    ]
                  "
                  [attr.id]="
                    getParam(conflict.name, module.name, 'member', idx)
                  "
                  class="restriction-list">
                  <li
                    data-test="restriction-element"
                    class="restriction-element"
                    *ngFor="
                      let restriction of conflict.texts.member.restrictions;
                      trackBy: trackByIndex
                    ">
                    {{ t(restriction) }}
                  </li>
                </ul>
              </td>
              <ng-template #member>
                <td
                  scope="row"
                  class="text"
                  [innerHtml]="t(text)"
                  data-test="member-conflict"></td>
              </ng-template>

              <td
                *ngIf="
                  isRestricted(conflict.texts.public.text[idx]) &&
                    conflict.texts.public.restrictions?.length;
                  else public
                ">
                <button
                  class="restrictions-btn"
                  [attr.aria-expanded]="
                    dropdown[
                      getParam(conflict.name, module.name, 'public', idx)
                    ]
                  "
                  [attr.aria-controls]="
                    getParam(conflict.name, module.name, 'public', idx)
                  "
                  data-test="public-restrictions-btn"
                  type="button"
                  (click)="
                    handleDropdown(
                      getParam(conflict.name, module.name, 'public', idx)
                    )
                  ">
                  <span
                    class="text highlight"
                    [innerHtml]="t(conflict.texts.public.text[idx])"
                    data-test="public-conflict"></span>
                  <tui-svg
                    class="chevron"
                    [src]="
                      dropdown[
                        getParam(conflict.name, module.name, 'public', idx)
                      ]
                        ? 'chevron-up'
                        : 'chevron-down'
                    ">
                  </tui-svg>
                </button>

                <ul
                  *ngIf="
                    dropdown[
                      getParam(conflict.name, module.name, 'public', idx)
                    ]
                  "
                  [attr.id]="
                    getParam(conflict.name, module.name, 'public', idx)
                  "
                  class="restriction-list">
                  <li
                    *ngFor="
                      let restriction of conflict.texts.public.restrictions;
                      trackBy: trackByIndex
                    "
                    class="restriction-element"
                    data-test="restriction-element">
                    {{ t(restriction) }}
                  </li>
                </ul>
              </td>
              <ng-template #public>
                <td
                  class="text"
                  [innerHtml]="t(conflict.texts.public.text[idx])"
                  data-test="public-conflict"></td>
              </ng-template>
            </tr>
          </tbody>
        </table>
      </ng-container>
      <div class="btn-wrapper">
        <button
          data-test="close-conflicts-modal"
          tuiButton
          (click)="close()"
          appearance="primary">
          {{ t('project_settings.modal_permissions.close') }}
        </button>
      </div>
    </div>
  </div>
</ng-container>
