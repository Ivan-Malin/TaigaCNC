<!--
This Source Code Form is subject to the terms of the Mozilla Public
License, v. 2.0. If a copy of the MPL was not distributed with this
file, You can obtain one at http://mozilla.org/MPL/2.0/.

Copyright (c) 2021-present Kaleidos Ventures SL
-->

<ng-container *transloco="let t">
  <ng-container *ngIf="model$ | async as vm">
    <div
      cdkTrapFocus
      class="story"
      *ngIf="vm.story">
      <div class="story-header">
        <div class="start">
          <a
            href="#"
            *ngIf="vm.selectedStoryView === 'full-view'"
            class="workflow"
            >{{ vm.story.workflow.name }}</a
          >
          <span
            #storyRef
            tabindex="0"
            [attr.aria-label]="
              t('kanban.story_detail.story_sr', {
                storyRef: vm.story.ref,
                storyTitle: vm.story.title
              })
            "
            class="story-ref story-detail-focus"
            [innerHtml]="
              t('kanban.story_detail.story', { storyRef: vm.story.ref })
            "></span>
          <button
            [attr.aria-label]="t('kanban.story_detail.copy_story')"
            [icon]="linkCopied ? 'check' : 'link'"
            appearance="tertiary"
            [class.copied]="linkCopied"
            class="copy-link"
            tuiIconButton
            [tuiHint]="
              linkCopied
                ? t('kanban.story_detail.link_copied')
                : t('kanban.story_detail.click_to_copy')
            "
            type="button"
            (click)="getStoryLink()"
            (focusout)="resetCopyLink()"
            (mouseleave)="resetCopyLink()"></button>
        </div>
        <div
          class="end"
          [class.no-close]="vm.selectedStoryView === 'full-view'">
          <button
            [disabled]="!vm.story.prev"
            [attr.aria-label]="t('kanban.story_detail.previous')"
            icon="chevron-left"
            appearance="tertiary"
            class="chevron"
            tuiIconButton
            tuiHintDirection="top-right"
            [tuiHint]="t('kanban.story_detail.previous')"
            (click)="navigateToStory(vm.story.prev)"
            type="button"></button>
          <button
            [disabled]="!vm.story.next"
            [attr.aria-label]="t('kanban.story_detail.next')"
            icon="chevron-right"
            appearance="tertiary"
            class="chevron"
            tuiIconButton
            tuiHintDirection="top-right"
            [tuiHint]="t('kanban.story_detail.next')"
            (click)="navigateToStory(vm.story.next)"
            type="button"></button>
          <tui-hosted-dropdown
            [tuiDropdownAlign]="'right'"
            [content]="changeView"
            [(open)]="dropdownState">
            <button
              [attr.aria-label]="
                t('kanban.story_detail.change_view_sr', {
                  currentView: getCurrentViewTranslation
                })
              "
              [icon]="vm.selectedStoryView"
              appearance="tertiary"
              class="change-view"
              tuiIconButton
              type="button"
              tuiHintDirection="top-right"
              [tuiHint]="t('kanban.story_detail.change_view')"
              (click)="(!dropdownState)"></button>
          </tui-hosted-dropdown>
          <button
            [attr.aria-label]="t('kanban.story_detail.story_options')"
            icon="more-vertical"
            appearance="tertiary"
            tuiIconButton
            type="button"></button>
          <button
            *ngIf="vm.selectedStoryView !== 'full-view'"
            [attr.aria-label]="t('kanban.story_detail.close')"
            icon="close"
            appearance="us-header-button"
            (click)="closeStory(vm.story?.ref)"
            tuiIconButton
            class="close-button"
            type="button"></button>
        </div>
        <ng-template #changeView>
          <tui-data-list class="view-options-list">
            <button
              *ngFor="let viewOption of storyViewOptions; trackBy: trackByIndex"
              class="view-option-btn"
              [class.selected]="viewOption.id === vm.selectedStoryView"
              tuiOption
              type="button"
              (click)="selectStoryView(viewOption.id)">
              <span class="view-option">
                <tui-svg
                  aria-hidden="true"
                  class="option-icon"
                  [src]="viewOption.id"></tui-svg>
                <span class="option-name">{{ t(viewOption.translation) }}</span>
              </span>
              <span class="shortcut">{{
                t('kanban.story_detail.ctrl_x')
              }}</span>
            </button>
          </tui-data-list>
        </ng-template>
      </div>
      <tui-scrollbar class="scrollbar-content">
        <div
          class="story-content"
          [class]="vm.selectedStoryView"
          [class.close]="!sidebarOpen && vm.selectedStoryView === 'side-view'">
          <div class="main-content">
            <h1 class="title">{{ vm.story.title }}</h1>
            <div class="creation-info">
              <tg-user-avatar
                size="m"
                class="no-border"
                [user]="vm.story.createdBy"
                type="light"
                [rounded]="true"
                aria-hidden></tg-user-avatar>
              <span class="creation-info-fullname">
                {{ vm.story.createdBy.fullName }}
              </span>
              <span
                *ngIf="vm.storyDateDistance"
                class="creation-info-date">
                {{
                  t('kanban.story_detail.story_date_distance', {
                    dateDistance: vm.storyDateDistance
                  })
                }}
              </span>
            </div>
          </div>
          <div class="sidebar">
            <button
              *ngIf="vm.selectedStoryView === 'side-view'"
              [attr.aria-label]="t('kanban.story_detail.collapse_sidebar')"
              [icon]="sidebarOpen ? 'chevrons-right' : 'chevrons-left'"
              appearance="tertiary"
              class="sidepanel-icon"
              tuiIconButton
              (click)="toggleSidebar.next()"
              type="button"></button>
          </div>
        </div>
      </tui-scrollbar>
    </div>
  </ng-container>
</ng-container>
