<!--
This Source Code Form is subject to the terms of the Mozilla Public
License, v. 2.0. If a copy of the MPL was not distributed with this
file, You can obtain one at http://mozilla.org/MPL/2.0/.

Copyright (c) 2021-present Kaleidos Ventures SL
-->

<ng-container *transloco="let t">
  <div class="wrapper">
    <h1 class="modal-title">
      {{ t('invitation_modal.title', { project: project.name }) }}
    </h1>
    <form
      class="form-container"
      [formGroup]="inviteProjectForm">
      <tui-scrollbar class="padding-scroll">
        <p
          class="text"
          [innerHtml]="t('invitation_modal.instructions')"></p>
        <p class="text">{{ t('invitation_modal.alternative') }}</p>
        <div class="add-wrapper">
          <tui-svg
            class="add-icon"
            src="user"
            aria-hidden="true"></tui-svg>
          <div class="text-area">
            <tg-ui-textarea>
              <tui-text-area
                class="invitation-textarea compressed"
                #emailInput
                tuiAutoFocus
                data-test="input-add-invites"
                [class.bottom-space]="
                  (emailsWithoutDuplications$ | async)!.length > 1
                "
                [class.invalid]="
                  inviteEmailsErrors.required ||
                  inviteEmailsErrors.regex ||
                  inviteEmailsErrors.peopleNotAdded ||
                  inviteEmailsErrors.bulkError
                "
                tuiTextfieldSize="s"
                [(ngModel)]="inviteEmails"
                (ngModelChange)="emailsChange($event)"
                [ngModelOptions]="{ standalone: true }"
                [expandable]="true"
                [rows]="12">
                {{ t('invitation_modal.placeholder') }}
              </tui-text-area>
              <tg-ui-error
                data-test="error-add-email"
                inputError
                [show]="inviteEmailsErrors.required">
                {{ t('invitation_modal.error_add_email') }}
              </tg-ui-error>
              <tg-ui-error
                data-test="error-regex"
                inputError
                [show]="inviteEmailsErrors.regex">
                {{ t('invitation_modal.error_email_regex') }}
              </tg-ui-error>
              <tg-ui-error
                data-test="error-missing-people"
                inputError
                [show]="inviteEmailsErrors.peopleNotAdded">
                {{ t('invitation_modal.error_missing_people') }}
              </tg-ui-error>
              <tg-ui-error
                inputError
                [show]="inviteEmailsErrors.bulkError">
                {{ t('invitation_modal.error_several_emails') }}
              </tg-ui-error>
            </tg-ui-textarea>
            <ng-container
              *ngIf="
                emailsWithoutDuplications$ | async as emailsWithoutDuplications
              ">
              <span
                data-test="email-count"
                *ngIf="emailsWithoutDuplications.length > 1"
                class="emails-count"
                [class.errors]="emailsHaveErrors"
                >{{
                  t('invitation_modal.emails_detected', {
                    emails: emailsWithoutDuplications.length
                  })
                }}</span
              >
            </ng-container>
          </div>
          <button
            data-test="add-invites"
            class="add-btn"
            appearance="primary"
            tuiButton
            (click)="addUser()"
            type="button">
            {{ t('invitation_modal.add') }}
          </button>
        </div>

        <ng-container *ngIf="users.length === 0">
          <div
            class="tip-wrapper"
            data-test="tip-wrapper">
            <tui-svg
              class="tip-icon"
              src="/assets/images/curved-arrow.svg"
              aria-hidden="true"></tui-svg>
            <p class="tip">{{ t('invitation_modal.add_people') }}</p>
          </div>
        </ng-container>

        <div
          *ngIf="users.length"
          class="user-list"
          data-test="user-list">
          <div class="user">
            <span></span>
            <span class="user-title">{{
              t('invitation_modal.name_email')
            }}</span>
            <span class="user-title">{{ t('invitation_modal.role') }}</span>
            <span></span>
          </div>

          <ng-container
            *ngFor="let user of users; index as i; trackBy: trackByIndex">
            <ng-container *ngIf="memberRoles$ | async as memberRoles">
              <tg-user-to-invite
                [user]="user"
                [userIndex]="i"
                [roles]="memberRoles"
                [isPending]="isPending(user.get('email')?.value)"
                (delete)="deleteUser($event)"></tg-user-to-invite>
            </ng-container>
          </ng-container>
        </div>
      </tui-scrollbar>
      <div class="actions-wrapper">
        <tg-ui-context-notification
          *ngIf="inviteEmailsErrors.listEmpty"
          data-test="error-at-lest-one"
          alertLevel="polite"
          class="notification"
          status="error">
          {{ t('invitation_modal.error_add_least_one') }}
        </tg-ui-context-notification>
        <tg-ui-context-notification
          *ngIf="inviteEmailsErrors.moreThanFifty && users.length > 50"
          class="notification"
          status="error"
          [hasIcon]="true">
          {{
            t('invitation_modal.error_more_than_fifty', {
              invitations: users.length - 50
            })
          }}
        </tg-ui-context-notification>
        <div class="form-actions">
          <button
            tuiLink
            (click)="close()"
            appearance="tertiary"
            data-test="close-modal">
            {{
              pending
                ? t('invitation_modal.close')
                : t('invitation_modal.later')
            }}
          </button>
          <button
            loading
            [loadingMsg]="t('invitation_modal.send_invites_in_progress')"
            [loadingSuccess]="t('invitation_modal.send_invites_success')"
            appearance="primary"
            data-test="submit-invite-users"
            tuiButton
            (click)="sendForm()"
            type="button">
            {{ t('invitation_modal.send_invites') }}
          </button>
        </div>
      </div>
    </form>
  </div>
</ng-container>
