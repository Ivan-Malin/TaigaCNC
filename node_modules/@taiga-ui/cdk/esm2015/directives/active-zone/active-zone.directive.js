var TuiActiveZoneDirective_1;
import { __decorate, __param } from "tslib";
import { DOCUMENT } from '@angular/common';
import { Directive, ElementRef, Inject, Input, NgZone, OnDestroy, Optional, Output, SkipSelf, } from '@angular/core';
import { WINDOW } from '@ng-web-apis/common';
import { tuiDefaultProp } from '@taiga-ui/cdk/decorators';
import { tuiZoneOptimized, typedFromEvent } from '@taiga-ui/cdk/observables';
import { getActualTarget } from '@taiga-ui/cdk/utils/dom';
import { getNativeFocused, isNativeFocused, isNativeMouseFocusable, } from '@taiga-ui/cdk/utils/focus';
import { merge, of } from 'rxjs';
import { distinctUntilChanged, filter, map, mapTo, skip, startWith, switchMap, take, tap, } from 'rxjs/operators';
// @dynamic
let TuiActiveZoneDirective = TuiActiveZoneDirective_1 = class TuiActiveZoneDirective {
    constructor(element, directParentActiveZone, ngZone, windowRef, documentRef) {
        this.element = element;
        this.directParentActiveZone = directParentActiveZone;
        this.subActiveZones = [];
        this.tuiActiveZoneParent = null;
        let skipNextFocusOut = false;
        if (this.directParentActiveZone) {
            this.directParentActiveZone.addSubActiveZone(this);
        }
        this.tuiActiveZoneChange = merge(typedFromEvent(windowRef, 'focusout').pipe(filter(event => {
            const actualTarget = getActualTarget(event);
            return (!skipNextFocusOut &&
                this.contains(actualTarget) &&
                !isNativeFocused(actualTarget) &&
                isValidFocusoutEvent(event) &&
                !this.contains(event.relatedTarget));
        }), mapTo(false)), typedFromEvent(windowRef, 'focusin').pipe(map(event => this.contains(getActualTarget(event)))), typedFromEvent(windowRef, 'mousedown').pipe(filter(event => documentRef.body === event.target ||
            !isNativeFocused(getActualTarget(event))), switchMap(event => {
            const actualTarget = getActualTarget(event);
            const targetInZone = this.contains(actualTarget);
            const activeElement = getNativeFocused(documentRef);
            const focusInZone = activeElement !== null && this.contains(activeElement);
            const focusNowhere = activeElement === null || activeElement === documentRef.body;
            // If default behavior is prevented â€” focus either remained
            // where it was or it was moved manually so we just check
            // if the focused element is within the zone or target is
            // within the zone and focus is nowhere
            if (event.defaultPrevented) {
                return of(focusInZone || (focusNowhere && targetInZone));
            }
            // If mouseDown happened inside the zone and focus is outside we
            // return true if target is not focusable or wait for focusIn
            if (targetInZone && !focusInZone && actualTarget instanceof Element) {
                return !isNativeMouseFocusable(actualTarget)
                    ? of(true)
                    : typedFromEvent(windowRef, 'focusin').pipe(take(1), mapTo(targetInZone));
            }
            // If focus is in the zone we wait for the next focusOut event and
            // map it to either true or false, depending on if the mouseDown
            // target is within the zone or not
            if (focusInZone) {
                // @bad TODO: Think of a way to handle this without side-effects
                skipNextFocusOut = true;
                return typedFromEvent(windowRef, 'focusout').pipe(take(1), mapTo(targetInZone));
            }
            return of(false);
        }))).pipe(tap(() => {
            skipNextFocusOut = false;
        }), startWith(false), distinctUntilChanged(), skip(1), tuiZoneOptimized(ngZone));
    }
    set tuiActiveZoneParentSetter(zone) {
        if (this.tuiActiveZoneParent) {
            this.tuiActiveZoneParent.removeSubActiveZone(this);
        }
        if (zone) {
            zone.addSubActiveZone(this);
        }
        this.tuiActiveZoneParent = zone;
    }
    ngOnDestroy() {
        if (!!this.directParentActiveZone) {
            this.directParentActiveZone.removeSubActiveZone(this);
        }
        if (!!this.tuiActiveZoneParent) {
            this.tuiActiveZoneParent.removeSubActiveZone(this);
        }
    }
    contains(node) {
        return (!!node &&
            (this.element.nativeElement.contains(node) ||
                this.subActiveZones.some((item, index, array) => array.indexOf(item) === index && item.contains(node))));
    }
    addSubActiveZone(activeZone) {
        this.subActiveZones = [...this.subActiveZones, activeZone];
    }
    removeSubActiveZone(activeZone) {
        const index = this.subActiveZones.findIndex(item => item === activeZone);
        this.subActiveZones = [
            ...this.subActiveZones.slice(0, index),
            ...this.subActiveZones.slice(index + 1),
        ];
    }
};
TuiActiveZoneDirective.ctorParameters = () => [
    { type: ElementRef, decorators: [{ type: Inject, args: [ElementRef,] }] },
    { type: TuiActiveZoneDirective, decorators: [{ type: Inject, args: [TuiActiveZoneDirective_1,] }, { type: Optional }, { type: SkipSelf }] },
    { type: NgZone, decorators: [{ type: Inject, args: [NgZone,] }] },
    { type: Window, decorators: [{ type: Inject, args: [WINDOW,] }] },
    { type: Document, decorators: [{ type: Inject, args: [DOCUMENT,] }] }
];
__decorate([
    Input('tuiActiveZoneParent'),
    tuiDefaultProp()
], TuiActiveZoneDirective.prototype, "tuiActiveZoneParentSetter", null);
__decorate([
    Output()
], TuiActiveZoneDirective.prototype, "tuiActiveZoneChange", void 0);
TuiActiveZoneDirective = TuiActiveZoneDirective_1 = __decorate([
    Directive({
        selector: '[tuiActiveZone]:not(ng-container), [tuiActiveZoneChange]:not(ng-container), [tuiActiveZoneParent]:not(ng-container)',
        exportAs: 'tuiActiveZone',
    }),
    __param(0, Inject(ElementRef)),
    __param(1, Inject(TuiActiveZoneDirective_1)),
    __param(1, Optional()),
    __param(1, SkipSelf()),
    __param(2, Inject(NgZone)),
    __param(3, Inject(WINDOW)),
    __param(4, Inject(DOCUMENT))
], TuiActiveZoneDirective);
export { TuiActiveZoneDirective };
// Chrome workaround for triggering `focusout` event upon element removal
function isValidFocusoutEvent({ relatedTarget, sourceCapabilities, }) {
    return sourceCapabilities !== null || relatedTarget !== null;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWN0aXZlLXpvbmUuZGlyZWN0aXZlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQHRhaWdhLXVpL2Nkay9kaXJlY3RpdmVzL2FjdGl2ZS16b25lLyIsInNvdXJjZXMiOlsiYWN0aXZlLXpvbmUuZGlyZWN0aXZlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsT0FBTyxFQUFDLFFBQVEsRUFBQyxNQUFNLGlCQUFpQixDQUFDO0FBQ3pDLE9BQU8sRUFDSCxTQUFTLEVBQ1QsVUFBVSxFQUNWLE1BQU0sRUFDTixLQUFLLEVBQ0wsTUFBTSxFQUNOLFNBQVMsRUFDVCxRQUFRLEVBQ1IsTUFBTSxFQUNOLFFBQVEsR0FDWCxNQUFNLGVBQWUsQ0FBQztBQUN2QixPQUFPLEVBQUMsTUFBTSxFQUFDLE1BQU0scUJBQXFCLENBQUM7QUFDM0MsT0FBTyxFQUFDLGNBQWMsRUFBQyxNQUFNLDBCQUEwQixDQUFDO0FBQ3hELE9BQU8sRUFBQyxnQkFBZ0IsRUFBRSxjQUFjLEVBQUMsTUFBTSwyQkFBMkIsQ0FBQztBQUMzRSxPQUFPLEVBQUMsZUFBZSxFQUFDLE1BQU0seUJBQXlCLENBQUM7QUFDeEQsT0FBTyxFQUNILGdCQUFnQixFQUNoQixlQUFlLEVBQ2Ysc0JBQXNCLEdBQ3pCLE1BQU0sMkJBQTJCLENBQUM7QUFDbkMsT0FBTyxFQUFDLEtBQUssRUFBYyxFQUFFLEVBQUMsTUFBTSxNQUFNLENBQUM7QUFDM0MsT0FBTyxFQUNILG9CQUFvQixFQUNwQixNQUFNLEVBQ04sR0FBRyxFQUNILEtBQUssRUFDTCxJQUFJLEVBQ0osU0FBUyxFQUNULFNBQVMsRUFDVCxJQUFJLEVBQ0osR0FBRyxHQUNOLE1BQU0sZ0JBQWdCLENBQUM7QUFFeEIsV0FBVztBQU1YLElBQWEsc0JBQXNCLDhCQUFuQyxNQUFhLHNCQUFzQjtJQXNCL0IsWUFDeUMsT0FBNEIsRUFJaEQsc0JBQXFELEVBQ3RELE1BQWMsRUFDZCxTQUFpQixFQUNmLFdBQXFCO1FBUEYsWUFBTyxHQUFQLE9BQU8sQ0FBcUI7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cEJ6QyxzQkFBc0I7SUFMbEMsU0FBUyxDQUFDO1FBQ1AsUUFBUSxFQUNKLHFIQUFxSDtRQUN6SCxRQUFRLEVBQUUsZUFBZTtLQUM1QixDQUFDO0lBd0JPLFdBQUEsTUFBTSxDQUFDLFVBQVUsQ0FBQyxDQUFBO0lBQ2xCLFdBQUEsTUFBTSxDQUFDLHdCQUFzQixDQUFDLENBQUE7SUFDOUIsV0FBQSxRQUFRLEVBQUUsQ0FBQTtJQUNWLFdBQUEsUUFBUSxFQUFFLENBQUE7SUFFVixXQUFBLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQTtJQUNkLFdBQUEsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFBO0lBQ2QsV0FBQSxNQUFNLENBQUMsUUFBUSxDQUFDLENBQUE7R0E5Qlosc0JBQXNCLENBc0psQztTQXRKWSxzQkFBc0I7QUF3Sm5DLHlFQUF5RTtBQUN6RSxTQUFTLG9CQUFvQixDQUFDLEVBQzFCLGFBQWEsRUFDYixrQkFBa0IsR0FDdUI7SUFDekMsT0FBTyxrQkFBa0IsS0FBSyxJQUFJLElBQUksYUFBYSxLQUFLLElBQUksQ0FBQztBQUNqRSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtET0NVTUVOVH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uJztcbmltcG9ydCB7XG4gICAgRGlyZWN0aXZlLFxuICAgIEVsZW1lbnRSZWYsXG4gICAgSW5qZWN0LFxuICAgIElucHV0LFxuICAgIE5nWm9uZSxcbiAgICBPbkRlc3Ryb3ksXG4gICAgT3B0aW9uYWwsXG4gICAgT3V0cHV0LFxuICAgIFNraXBTZWxmLFxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7V0lORE9XfSBmcm9tICdAbmctd2ViLWFwaXMvY29tbW9uJztcbmltcG9ydCB7dHVpRGVmYXVsdFByb3B9IGZyb20gJ0B0YWlnYS11aS9jZGsvZGVjb3JhdG9ycyc7XG5pbXBvcnQge3R1aVpvbmVPcHRpbWl6ZWQsIHR5cGVkRnJvbUV2ZW50fSBmcm9tICdAdGFpZ2EtdWkvY2RrL29ic2VydmFibGVzJztcbmltcG9ydCB7Z2V0QWN0dWFsVGFyZ2V0fSBmcm9tICdAdGFpZ2EtdWkvY2RrL3V0aWxzL2RvbSc7XG5pbXBvcnQge1xuICAgIGdldE5hdGl2ZUZvY3VzZWQsXG4gICAgaXNOYXRpdmVGb2N1c2VkLFxuICAgIGlzTmF0aXZlTW91c2VGb2N1c2FibGUsXG59IGZyb20gJ0B0YWlnYS11aS9jZGsvdXRpbHMvZm9jdXMnO1xuaW1wb3J0IHttZXJnZSwgT2JzZXJ2YWJsZSwgb2Z9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHtcbiAgICBkaXN0aW5jdFVudGlsQ2hhbmdlZCxcbiAgICBmaWx0ZXIsXG4gICAgbWFwLFxuICAgIG1hcFRvLFxuICAgIHNraXAsXG4gICAgc3RhcnRXaXRoLFxuICAgIHN3aXRjaE1hcCxcbiAgICB0YWtlLFxuICAgIHRhcCxcbn0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuXG4vLyBAZHluYW1pY1xuQERpcmVjdGl2ZSh7XG4gICAgc2VsZWN0b3I6XG4gICAgICAgICdbdHVpQWN0aXZlWm9uZV06bm90KG5nLWNvbnRhaW5lciksIFt0dWlBY3RpdmVab25lQ2hhbmdlXTpub3QobmctY29udGFpbmVyKSwgW3R1aUFjdGl2ZVpvbmVQYXJlbnRdOm5vdChuZy1jb250YWluZXIpJyxcbiAgICBleHBvcnRBczogJ3R1aUFjdGl2ZVpvbmUnLFxufSlcbmV4cG9ydCBjbGFzcyBUdWlBY3RpdmVab25lRGlyZWN0aXZlIGltcGxlbWVudHMgT25EZXN0cm95IHtcbiAgICBwcml2YXRlIHN1YkFjdGl2ZVpvbmVzOiBSZWFkb25seUFycmF5PFR1aUFjdGl2ZVpvbmVEaXJlY3RpdmU+ID0gW107XG5cbiAgICBwcml2YXRlIHR1aUFjdGl2ZVpvbmVQYXJlbnQ6IFR1aUFjdGl2ZVpvbmVEaXJlY3RpdmUgfCBudWxsID0gbnVsbDtcblxuICAgIEBJbnB1dCgndHVpQWN0aXZlWm9uZVBhcmVudCcpXG4gICAgQHR1aURlZmF1bHRQcm9wKClcbiAgICBzZXQgdHVpQWN0aXZlWm9uZVBhcmVudFNldHRlcih6b25lOiBUdWlBY3RpdmVab25lRGlyZWN0aXZlIHwgbnVsbCkge1xuICAgICAgICBpZiAodGhpcy50dWlBY3RpdmVab25lUGFyZW50KSB7XG4gICAgICAgICAgICB0aGlzLnR1aUFjdGl2ZVpvbmVQYXJlbnQucmVtb3ZlU3ViQWN0aXZlWm9uZSh0aGlzKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICh6b25lKSB7XG4gICAgICAgICAgICB6b25lLmFkZFN1YkFjdGl2ZVpvbmUodGhpcyk7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLnR1aUFjdGl2ZVpvbmVQYXJlbnQgPSB6b25lO1xuICAgIH1cblxuICAgIEBPdXRwdXQoKVxuICAgIHJlYWRvbmx5IHR1aUFjdGl2ZVpvbmVDaGFuZ2U6IE9ic2VydmFibGU8Ym9vbGVhbj47XG5cbiAgICBjb25zdHJ1Y3RvcihcbiAgICAgICAgQEluamVjdChFbGVtZW50UmVmKSBwcml2YXRlIHJlYWRvbmx5IGVsZW1lbnQ6IEVsZW1lbnRSZWY8RWxlbWVudD4sXG4gICAgICAgIEBJbmplY3QoVHVpQWN0aXZlWm9uZURpcmVjdGl2ZSlcbiAgICAgICAgQE9wdGlvbmFsKClcbiAgICAgICAgQFNraXBTZWxmKClcbiAgICAgICAgcHJpdmF0ZSByZWFkb25seSBkaXJlY3RQYXJlbnRBY3RpdmVab25lOiBUdWlBY3RpdmVab25lRGlyZWN0aXZlIHwgbnVsbCxcbiAgICAgICAgQEluamVjdChOZ1pvbmUpIG5nWm9uZTogTmdab25lLFxuICAgICAgICBASW5qZWN0KFdJTkRPVykgd2luZG93UmVmOiBXaW5kb3csXG4gICAgICAgIEBJbmplY3QoRE9DVU1FTlQpIGRvY3VtZW50UmVmOiBEb2N1bWVudCxcbiAgICApIHtcbiAgICAgICAgbGV0IHNraXBOZXh0Rm9jdXNPdXQgPSBmYWxzZTtcblxuICAgICAgICBpZiAodGhpcy5kaXJlY3RQYXJlbnRBY3RpdmVab25lKSB7XG4gICAgICAgICAgICB0aGlzLmRpcmVjdFBhcmVudEFjdGl2ZVpvbmUuYWRkU3ViQWN0aXZlWm9uZSh0aGlzKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMudHVpQWN0aXZlWm9uZUNoYW5nZSA9IG1lcmdlKFxuICAgICAgICAgICAgdHlwZWRGcm9tRXZlbnQod2luZG93UmVmLCAnZm9jdXNvdXQnKS5waXBlKFxuICAgICAgICAgICAgICAgIGZpbHRlcihldmVudCA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGFjdHVhbFRhcmdldCA9IGdldEFjdHVhbFRhcmdldChldmVudCk7XG5cbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICAgICAgICAgICAgICAgICFza2lwTmV4dEZvY3VzT3V0ICYmXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbnRhaW5zKGFjdHVhbFRhcmdldCkgJiZcbiAgICAgICAgICAgICAgICAgICAgICAgICFpc05hdGl2ZUZvY3VzZWQoYWN0dWFsVGFyZ2V0KSAmJlxuICAgICAgICAgICAgICAgICAgICAgICAgaXNWYWxpZEZvY3Vzb3V0RXZlbnQoZXZlbnQgYXMgYW55KSAmJlxuICAgICAgICAgICAgICAgICAgICAgICAgIXRoaXMuY29udGFpbnMoZXZlbnQucmVsYXRlZFRhcmdldCBhcyBOb2RlIHwgbnVsbClcbiAgICAgICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICB9KSxcbiAgICAgICAgICAgICAgICBtYXBUbyhmYWxzZSksXG4gICAgICAgICAgICApLFxuICAgICAgICAgICAgdHlwZWRGcm9tRXZlbnQod2luZG93UmVmLCAnZm9jdXNpbicpLnBpcGUoXG4gICAgICAgICAgICAgICAgbWFwKGV2ZW50ID0+IHRoaXMuY29udGFpbnMoZ2V0QWN0dWFsVGFyZ2V0KGV2ZW50KSkpLFxuICAgICAgICAgICAgKSxcbiAgICAgICAgICAgIHR5cGVkRnJvbUV2ZW50KHdpbmRvd1JlZiwgJ21vdXNlZG93bicpLnBpcGUoXG4gICAgICAgICAgICAgICAgZmlsdGVyKFxuICAgICAgICAgICAgICAgICAgICBldmVudCA9PlxuICAgICAgICAgICAgICAgICAgICAgICAgZG9jdW1lbnRSZWYuYm9keSA9PT0gZXZlbnQudGFyZ2V0IHx8XG4gICAgICAgICAgICAgICAgICAgICAgICAhaXNOYXRpdmVGb2N1c2VkKGdldEFjdHVhbFRhcmdldChldmVudCkpLFxuICAgICAgICAgICAgICAgICksXG4gICAgICAgICAgICAgICAgc3dpdGNoTWFwKGV2ZW50ID0+IHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgYWN0dWFsVGFyZ2V0ID0gZ2V0QWN0dWFsVGFyZ2V0KGV2ZW50KTtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgdGFyZ2V0SW5ab25lID0gdGhpcy5jb250YWlucyhhY3R1YWxUYXJnZXQpO1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBhY3RpdmVFbGVtZW50ID0gZ2V0TmF0aXZlRm9jdXNlZChkb2N1bWVudFJlZik7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGZvY3VzSW5ab25lID1cbiAgICAgICAgICAgICAgICAgICAgICAgIGFjdGl2ZUVsZW1lbnQgIT09IG51bGwgJiYgdGhpcy5jb250YWlucyhhY3RpdmVFbGVtZW50KTtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgZm9jdXNOb3doZXJlID1cbiAgICAgICAgICAgICAgICAgICAgICAgIGFjdGl2ZUVsZW1lbnQgPT09IG51bGwgfHwgYWN0aXZlRWxlbWVudCA9PT0gZG9jdW1lbnRSZWYuYm9keTtcblxuICAgICAgICAgICAgICAgICAgICAvLyBJZiBkZWZhdWx0IGJlaGF2aW9yIGlzIHByZXZlbnRlZCDigJQgZm9jdXMgZWl0aGVyIHJlbWFpbmVkXG4gICAgICAgICAgICAgICAgICAgIC8vIHdoZXJlIGl0IHdhcyBvciBpdCB3YXMgbW92ZWQgbWFudWFsbHkgc28gd2UganVzdCBjaGVja1xuICAgICAgICAgICAgICAgICAgICAvLyBpZiB0aGUgZm9jdXNlZCBlbGVtZW50IGlzIHdpdGhpbiB0aGUgem9uZSBvciB0YXJnZXQgaXNcbiAgICAgICAgICAgICAgICAgICAgLy8gd2l0aGluIHRoZSB6b25lIGFuZCBmb2N1cyBpcyBub3doZXJlXG4gICAgICAgICAgICAgICAgICAgIGlmIChldmVudC5kZWZhdWx0UHJldmVudGVkKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gb2YoZm9jdXNJblpvbmUgfHwgKGZvY3VzTm93aGVyZSAmJiB0YXJnZXRJblpvbmUpKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgIC8vIElmIG1vdXNlRG93biBoYXBwZW5lZCBpbnNpZGUgdGhlIHpvbmUgYW5kIGZvY3VzIGlzIG91dHNpZGUgd2VcbiAgICAgICAgICAgICAgICAgICAgLy8gcmV0dXJuIHRydWUgaWYgdGFyZ2V0IGlzIG5vdCBmb2N1c2FibGUgb3Igd2FpdCBmb3IgZm9jdXNJblxuICAgICAgICAgICAgICAgICAgICBpZiAodGFyZ2V0SW5ab25lICYmICFmb2N1c0luWm9uZSAmJiBhY3R1YWxUYXJnZXQgaW5zdGFuY2VvZiBFbGVtZW50KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gIWlzTmF0aXZlTW91c2VGb2N1c2FibGUoYWN0dWFsVGFyZ2V0KVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgID8gb2YodHJ1ZSlcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICA6IHR5cGVkRnJvbUV2ZW50KHdpbmRvd1JlZiwgJ2ZvY3VzaW4nKS5waXBlKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRha2UoMSksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWFwVG8odGFyZ2V0SW5ab25lKSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICAvLyBJZiBmb2N1cyBpcyBpbiB0aGUgem9uZSB3ZSB3YWl0IGZvciB0aGUgbmV4dCBmb2N1c091dCBldmVudCBhbmRcbiAgICAgICAgICAgICAgICAgICAgLy8gbWFwIGl0IHRvIGVpdGhlciB0cnVlIG9yIGZhbHNlLCBkZXBlbmRpbmcgb24gaWYgdGhlIG1vdXNlRG93blxuICAgICAgICAgICAgICAgICAgICAvLyB0YXJnZXQgaXMgd2l0aGluIHRoZSB6b25lIG9yIG5vdFxuICAgICAgICAgICAgICAgICAgICBpZiAoZm9jdXNJblpvbmUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEBiYWQgVE9ETzogVGhpbmsgb2YgYSB3YXkgdG8gaGFuZGxlIHRoaXMgd2l0aG91dCBzaWRlLWVmZmVjdHNcbiAgICAgICAgICAgICAgICAgICAgICAgIHNraXBOZXh0Rm9jdXNPdXQgPSB0cnVlO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHlwZWRGcm9tRXZlbnQod2luZG93UmVmLCAnZm9jdXNvdXQnKS5waXBlKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRha2UoMSksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbWFwVG8odGFyZ2V0SW5ab25lKSxcbiAgICAgICAgICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gb2YoZmFsc2UpO1xuICAgICAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgKSxcbiAgICAgICAgKS5waXBlKFxuICAgICAgICAgICAgdGFwKCgpID0+IHtcbiAgICAgICAgICAgICAgICBza2lwTmV4dEZvY3VzT3V0ID0gZmFsc2U7XG4gICAgICAgICAgICB9KSxcbiAgICAgICAgICAgIHN0YXJ0V2l0aChmYWxzZSksXG4gICAgICAgICAgICBkaXN0aW5jdFVudGlsQ2hhbmdlZCgpLFxuICAgICAgICAgICAgc2tpcCgxKSxcbiAgICAgICAgICAgIHR1aVpvbmVPcHRpbWl6ZWQobmdab25lKSxcbiAgICAgICAgKTtcbiAgICB9XG5cbiAgICBuZ09uRGVzdHJveSgpIHtcbiAgICAgICAgaWYgKCEhdGhpcy5kaXJlY3RQYXJlbnRBY3RpdmVab25lKSB7XG4gICAgICAgICAgICB0aGlzLmRpcmVjdFBhcmVudEFjdGl2ZVpvbmUucmVtb3ZlU3ViQWN0aXZlWm9uZSh0aGlzKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghIXRoaXMudHVpQWN0aXZlWm9uZVBhcmVudCkge1xuICAgICAgICAgICAgdGhpcy50dWlBY3RpdmVab25lUGFyZW50LnJlbW92ZVN1YkFjdGl2ZVpvbmUodGhpcyk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBjb250YWlucyhub2RlOiBOb2RlIHwgbnVsbCk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gKFxuICAgICAgICAgICAgISFub2RlICYmXG4gICAgICAgICAgICAodGhpcy5lbGVtZW50Lm5hdGl2ZUVsZW1lbnQuY29udGFpbnMobm9kZSkgfHxcbiAgICAgICAgICAgICAgICB0aGlzLnN1YkFjdGl2ZVpvbmVzLnNvbWUoXG4gICAgICAgICAgICAgICAgICAgIChpdGVtLCBpbmRleCwgYXJyYXkpID0+XG4gICAgICAgICAgICAgICAgICAgICAgICBhcnJheS5pbmRleE9mKGl0ZW0pID09PSBpbmRleCAmJiBpdGVtLmNvbnRhaW5zKG5vZGUpLFxuICAgICAgICAgICAgICAgICkpXG4gICAgICAgICk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBhZGRTdWJBY3RpdmVab25lKGFjdGl2ZVpvbmU6IFR1aUFjdGl2ZVpvbmVEaXJlY3RpdmUpIHtcbiAgICAgICAgdGhpcy5zdWJBY3RpdmVab25lcyA9IFsuLi50aGlzLnN1YkFjdGl2ZVpvbmVzLCBhY3RpdmVab25lXTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHJlbW92ZVN1YkFjdGl2ZVpvbmUoYWN0aXZlWm9uZTogVHVpQWN0aXZlWm9uZURpcmVjdGl2ZSkge1xuICAgICAgICBjb25zdCBpbmRleCA9IHRoaXMuc3ViQWN0aXZlWm9uZXMuZmluZEluZGV4KGl0ZW0gPT4gaXRlbSA9PT0gYWN0aXZlWm9uZSk7XG5cbiAgICAgICAgdGhpcy5zdWJBY3RpdmVab25lcyA9IFtcbiAgICAgICAgICAgIC4uLnRoaXMuc3ViQWN0aXZlWm9uZXMuc2xpY2UoMCwgaW5kZXgpLFxuICAgICAgICAgICAgLi4udGhpcy5zdWJBY3RpdmVab25lcy5zbGljZShpbmRleCArIDEpLFxuICAgICAgICBdO1xuICAgIH1cbn1cblxuLy8gQ2hyb21lIHdvcmthcm91bmQgZm9yIHRyaWdnZXJpbmcgYGZvY3Vzb3V0YCBldmVudCB1cG9uIGVsZW1lbnQgcmVtb3ZhbFxuZnVuY3Rpb24gaXNWYWxpZEZvY3Vzb3V0RXZlbnQoe1xuICAgIHJlbGF0ZWRUYXJnZXQsXG4gICAgc291cmNlQ2FwYWJpbGl0aWVzLFxufTogRm9jdXNFdmVudCAmIHtzb3VyY2VDYXBhYmlsaXRpZXM6IHVua25vd259KTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHNvdXJjZUNhcGFiaWxpdGllcyAhPT0gbnVsbCB8fCByZWxhdGVkVGFyZ2V0ICE9PSBudWxsO1xufVxuIl19