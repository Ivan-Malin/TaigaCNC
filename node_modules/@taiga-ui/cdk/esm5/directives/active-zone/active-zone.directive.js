import { __decorate, __param, __read, __spread } from "tslib";
import { DOCUMENT } from '@angular/common';
import { Directive, ElementRef, Inject, Input, NgZone, OnDestroy, Optional, Output, SkipSelf, } from '@angular/core';
import { WINDOW } from '@ng-web-apis/common';
import { tuiDefaultProp } from '@taiga-ui/cdk/decorators';
import { tuiZoneOptimized, typedFromEvent } from '@taiga-ui/cdk/observables';
import { getActualTarget } from '@taiga-ui/cdk/utils/dom';
import { getNativeFocused, isNativeFocused, isNativeMouseFocusable, } from '@taiga-ui/cdk/utils/focus';
import { merge, of } from 'rxjs';
import { distinctUntilChanged, filter, map, mapTo, skip, startWith, switchMap, take, tap, } from 'rxjs/operators';
// @dynamic
var TuiActiveZoneDirective = /** @class */ (function () {
    function TuiActiveZoneDirective(element, directParentActiveZone, ngZone, windowRef, documentRef) {
        var _this = this;
        this.element = element;
        this.directParentActiveZone = directParentActiveZone;
        this.subActiveZones = [];
        this.tuiActiveZoneParent = null;
        var skipNextFocusOut = false;
        if (this.directParentActiveZone) {
            this.directParentActiveZone.addSubActiveZone(this);
        }
        this.tuiActiveZoneChange = merge(typedFromEvent(windowRef, 'focusout').pipe(filter(function (event) {
            var actualTarget = getActualTarget(event);
            return (!skipNextFocusOut &&
                _this.contains(actualTarget) &&
                !isNativeFocused(actualTarget) &&
                isValidFocusoutEvent(event) &&
                !_this.contains(event.relatedTarget));
        }), mapTo(false)), typedFromEvent(windowRef, 'focusin').pipe(map(function (event) { return _this.contains(getActualTarget(event)); })), typedFromEvent(windowRef, 'mousedown').pipe(filter(function (event) {
            return documentRef.body === event.target ||
                !isNativeFocused(getActualTarget(event));
        }), switchMap(function (event) {
            var actualTarget = getActualTarget(event);
            var targetInZone = _this.contains(actualTarget);
            var activeElement = getNativeFocused(documentRef);
            var focusInZone = activeElement !== null && _this.contains(activeElement);
            var focusNowhere = activeElement === null || activeElement === documentRef.body;
            // If default behavior is prevented â€” focus either remained
            // where it was or it was moved manually so we just check
            // if the focused element is within the zone or target is
            // within the zone and focus is nowhere
            if (event.defaultPrevented) {
                return of(focusInZone || (focusNowhere && targetInZone));
            }
            // If mouseDown happened inside the zone and focus is outside we
            // return true if target is not focusable or wait for focusIn
            if (targetInZone && !focusInZone && actualTarget instanceof Element) {
                return !isNativeMouseFocusable(actualTarget)
                    ? of(true)
                    : typedFromEvent(windowRef, 'focusin').pipe(take(1), mapTo(targetInZone));
            }
            // If focus is in the zone we wait for the next focusOut event and
            // map it to either true or false, depending on if the mouseDown
            // target is within the zone or not
            if (focusInZone) {
                // @bad TODO: Think of a way to handle this without side-effects
                skipNextFocusOut = true;
                return typedFromEvent(windowRef, 'focusout').pipe(take(1), mapTo(targetInZone));
            }
            return of(false);
        }))).pipe(tap(function () {
            skipNextFocusOut = false;
        }), startWith(false), distinctUntilChanged(), skip(1), tuiZoneOptimized(ngZone));
    }
    TuiActiveZoneDirective_1 = TuiActiveZoneDirective;
    Object.defineProperty(TuiActiveZoneDirective.prototype, "tuiActiveZoneParentSetter", {
        set: function (zone) {
            if (this.tuiActiveZoneParent) {
                this.tuiActiveZoneParent.removeSubActiveZone(this);
            }
            if (zone) {
                zone.addSubActiveZone(this);
            }
            this.tuiActiveZoneParent = zone;
        },
        enumerable: true,
        configurable: true
    });
    TuiActiveZoneDirective.prototype.ngOnDestroy = function () {
        if (!!this.directParentActiveZone) {
            this.directParentActiveZone.removeSubActiveZone(this);
        }
        if (!!this.tuiActiveZoneParent) {
            this.tuiActiveZoneParent.removeSubActiveZone(this);
        }
    };
    TuiActiveZoneDirective.prototype.contains = function (node) {
        return (!!node &&
            (this.element.nativeElement.contains(node) ||
                this.subActiveZones.some(function (item, index, array) {
                    return array.indexOf(item) === index && item.contains(node);
                })));
    };
    TuiActiveZoneDirective.prototype.addSubActiveZone = function (activeZone) {
        this.subActiveZones = __spread(this.subActiveZones, [activeZone]);
    };
    TuiActiveZoneDirective.prototype.removeSubActiveZone = function (activeZone) {
        var index = this.subActiveZones.findIndex(function (item) { return item === activeZone; });
        this.subActiveZones = __spread(this.subActiveZones.slice(0, index), this.subActiveZones.slice(index + 1));
    };
    var TuiActiveZoneDirective_1;
    TuiActiveZoneDirective.ctorParameters = function () { return [
        { type: ElementRef, decorators: [{ type: Inject, args: [ElementRef,] }] },
        { type: TuiActiveZoneDirective, decorators: [{ type: Inject, args: [TuiActiveZoneDirective_1,] }, { type: Optional }, { type: SkipSelf }] },
        { type: NgZone, decorators: [{ type: Inject, args: [NgZone,] }] },
        { type: Window, decorators: [{ type: Inject, args: [WINDOW,] }] },
        { type: Document, decorators: [{ type: Inject, args: [DOCUMENT,] }] }
    ]; };
    __decorate([
        Input('tuiActiveZoneParent'),
        tuiDefaultProp()
    ], TuiActiveZoneDirective.prototype, "tuiActiveZoneParentSetter", null);
    __decorate([
        Output()
    ], TuiActiveZoneDirective.prototype, "tuiActiveZoneChange", void 0);
    TuiActiveZoneDirective = TuiActiveZoneDirective_1 = __decorate([
        Directive({
            selector: '[tuiActiveZone]:not(ng-container), [tuiActiveZoneChange]:not(ng-container), [tuiActiveZoneParent]:not(ng-container)',
            exportAs: 'tuiActiveZone',
        }),
        __param(0, Inject(ElementRef)),
        __param(1, Inject(TuiActiveZoneDirective_1)),
        __param(1, Optional()),
        __param(1, SkipSelf()),
        __param(2, Inject(NgZone)),
        __param(3, Inject(WINDOW)),
        __param(4, Inject(DOCUMENT))
    ], TuiActiveZoneDirective);
    return TuiActiveZoneDirective;
}());
export { TuiActiveZoneDirective };
// Chrome workaround for triggering `focusout` event upon element removal
function isValidFocusoutEvent(_a) {
    var relatedTarget = _a.relatedTarget, sourceCapabilities = _a.sourceCapabilities;
    return sourceCapabilities !== null || relatedTarget !== null;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWN0aXZlLXpvbmUuZGlyZWN0aXZlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQHRhaWdhLXVpL2Nkay9kaXJlY3RpdmVzL2FjdGl2ZS16b25lLyIsInNvdXJjZXMiOlsiYWN0aXZlLXpvbmUuZGlyZWN0aXZlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUMsUUFBUSxFQUFDLE1BQU0saUJBQWlCLENBQUM7QUFDekMsT0FBTyxFQUNILFNBQVMsRUFDVCxVQUFVLEVBQ1YsTUFBTSxFQUNOLEtBQUssRUFDTCxNQUFNLEVBQ04sU0FBUyxFQUNULFFBQVEsRUFDUixNQUFNLEVBQ04sUUFBUSxHQUNYLE1BQU0sZUFBZSxDQUFDO0FBQ3ZCLE9BQU8sRUFBQyxNQUFNLEVBQUMsTUFBTSxxQkFBcUIsQ0FBQztBQUMzQyxPQUFPLEVBQUMsY0FBYyxFQUFDLE1BQU0sMEJBQTBCLENBQUM7QUFDeEQsT0FBTyxFQUFDLGdCQUFnQixFQUFFLGNBQWMsRUFBQyxNQUFNLDJCQUEyQixDQUFDO0FBQzNFLE9BQU8sRUFBQyxlQUFlLEVBQUMsTUFBTSx5QkFBeUIsQ0FBQztBQUN4RCxPQUFPLEVBQ0gsZ0JBQWdCLEVBQ2hCLGVBQWUsRUFDZixzQkFBc0IsR0FDekIsTUFBTSwyQkFBMkIsQ0FBQztBQUNuQyxPQUFPLEVBQUMsS0FBSyxFQUFjLEVBQUUsRUFBQyxNQUFNLE1BQU0sQ0FBQztBQUMzQyxPQUFPLEVBQ0gsb0JBQW9CLEVBQ3BCLE1BQU0sRUFDTixHQUFHLEVBQ0gsS0FBSyxFQUNMLElBQUksRUFDSixTQUFTLEVBQ1QsU0FBUyxFQUNULElBQUksRUFDSixHQUFHLEdBQ04sTUFBTSxnQkFBZ0IsQ0FBQztBQUV4QixXQUFXO0FBTVg7SUFzQkksZ0NBQ3lDLE9BQTRCLEVBSWhELHNCQUFxRCxFQUN0RCxNQUFjLEVBQ2QsU0FBaUIsRUFDZixXQUFxQjtRQVIzQyxpQkE2RkM7UUE1RndDLFlBQU8sR0FBUCxPQUFPLENBQXFCO1FBSWhELDJCQUFzQixHQUF0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RUFXaEI7SUFHRDtRQURDLE1BQU0sRUFBRTt1RUFDeUM7SUFwQnpDLHNCQUFzQjtRQUxsQyxTQUFTLENBQUM7WUFDUCxRQUFRLEVBQ0oscUhBQXFIO1lBQ3pILFFBQVEsRUFBRSxlQUFlO1NBQzVCLENBQUM7UUF3Qk8sV0FBQSxNQUFNLENBQUMsVUFBVSxDQUFDLENBQUE7UUFDbEIsV0FBQSxNQUFNLENBQUMsd0JBQXNCLENBQUMsQ0FBQTtRQUM5QixXQUFBLFFBQVEsRUFBRSxDQUFBO1FBQ1YsV0FBQSxRQUFRLEVBQUUsQ0FBQTtRQUVWLFdBQUEsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFBO1FBQ2QsV0FBQSxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUE7UUFDZCxXQUFBLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQTtPQTlCWixzQkFBc0IsQ0FzSmxDO0lBQUQsNkJBQUM7Q0FBQSxBQXRKRCxJQXNKQztTQXRKWSxzQkFBc0I7QUF3Sm5DLHlFQUF5RTtBQUN6RSxTQUFTLG9CQUFvQixDQUFDLEVBR2U7UUFGekMsZ0NBQWEsRUFDYiwwQ0FBa0I7SUFFbEIsT0FBTyxrQkFBa0IsS0FBSyxJQUFJLElBQUksYUFBYSxLQUFLLElBQUksQ0FBQztBQUNqRSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtET0NVTUVOVH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uJztcbmltcG9ydCB7XG4gICAgRGlyZWN0aXZlLFxuICAgIEVsZW1lbnRSZWYsXG4gICAgSW5qZWN0LFxuICAgIElucHV0LFxuICAgIE5nWm9uZSxcbiAgICBPbkRlc3Ryb3ksXG4gICAgT3B0aW9uYWwsXG4gICAgT3V0cHV0LFxuICAgIFNraXBTZWxmLFxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7V0lORE9XfSBmcm9tICdAbmctd2ViLWFwaXMvY29tbW9uJztcbmltcG9ydCB7dHVpRGVmYXVsdFByb3B9IGZyb20gJ0B0YWlnYS11aS9jZGsvZGVjb3JhdG9ycyc7XG5pbXBvcnQge3R1aVpvbmVPcHRpbWl6ZWQsIHR5cGVkRnJvbUV2ZW50fSBmcm9tICdAdGFpZ2EtdWkvY2RrL29ic2VydmFibGVzJztcbmltcG9ydCB7Z2V0QWN0dWFsVGFyZ2V0fSBmcm9tICdAdGFpZ2EtdWkvY2RrL3V0aWxzL2RvbSc7XG5pbXBvcnQge1xuICAgIGdldE5hdGl2ZUZvY3VzZWQsXG4gICAgaXNOYXRpdmVGb2N1c2VkLFxuICAgIGlzTmF0aXZlTW91c2VGb2N1c2FibGUsXG59IGZyb20gJ0B0YWlnYS11aS9jZGsvdXRpbHMvZm9jdXMnO1xuaW1wb3J0IHttZXJnZSwgT2JzZXJ2YWJsZSwgb2Z9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHtcbiAgICBkaXN0aW5jdFVudGlsQ2hhbmdlZCxcbiAgICBmaWx0ZXIsXG4gICAgbWFwLFxuICAgIG1hcFRvLFxuICAgIHNraXAsXG4gICAgc3RhcnRXaXRoLFxuICAgIHN3aXRjaE1hcCxcbiAgICB0YWtlLFxuICAgIHRhcCxcbn0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuXG4vLyBAZHluYW1pY1xuQERpcmVjdGl2ZSh7XG4gICAgc2VsZWN0b3I6XG4gICAgICAgICdbdHVpQWN0aXZlWm9uZV06bm90KG5nLWNvbnRhaW5lciksIFt0dWlBY3RpdmVab25lQ2hhbmdlXTpub3QobmctY29udGFpbmVyKSwgW3R1aUFjdGl2ZVpvbmVQYXJlbnRdOm5vdChuZy1jb250YWluZXIpJyxcbiAgICBleHBvcnRBczogJ3R1aUFjdGl2ZVpvbmUnLFxufSlcbmV4cG9ydCBjbGFzcyBUdWlBY3RpdmVab25lRGlyZWN0aXZlIGltcGxlbWVudHMgT25EZXN0cm95IHtcbiAgICBwcml2YXRlIHN1YkFjdGl2ZVpvbmVzOiBSZWFkb25seUFycmF5PFR1aUFjdGl2ZVpvbmVEaXJlY3RpdmU+ID0gW107XG5cbiAgICBwcml2YXRlIHR1aUFjdGl2ZVpvbmVQYXJlbnQ6IFR1aUFjdGl2ZVpvbmVEaXJlY3RpdmUgfCBudWxsID0gbnVsbDtcblxuICAgIEBJbnB1dCgndHVpQWN0aXZlWm9uZVBhcmVudCcpXG4gICAgQHR1aURlZmF1bHRQcm9wKClcbiAgICBzZXQgdHVpQWN0aXZlWm9uZVBhcmVudFNldHRlcih6b25lOiBUdWlBY3RpdmVab25lRGlyZWN0aXZlIHwgbnVsbCkge1xuICAgICAgICBpZiAodGhpcy50dWlBY3RpdmVab25lUGFyZW50KSB7XG4gICAgICAgICAgICB0aGlzLnR1aUFjdGl2ZVpvbmVQYXJlbnQucmVtb3ZlU3ViQWN0aXZlWm9uZSh0aGlzKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICh6b25lKSB7XG4gICAgICAgICAgICB6b25lLmFkZFN1YkFjdGl2ZVpvbmUodGhpcyk7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLnR1aUFjdGl2ZVpvbmVQYXJlbnQgPSB6b25lO1xuICAgIH1cblxuICAgIEBPdXRwdXQoKVxuICAgIHJlYWRvbmx5IHR1aUFjdGl2ZVpvbmVDaGFuZ2U6IE9ic2VydmFibGU8Ym9vbGVhbj47XG5cbiAgICBjb25zdHJ1Y3RvcihcbiAgICAgICAgQEluamVjdChFbGVtZW50UmVmKSBwcml2YXRlIHJlYWRvbmx5IGVsZW1lbnQ6IEVsZW1lbnRSZWY8RWxlbWVudD4sXG4gICAgICAgIEBJbmplY3QoVHVpQWN0aXZlWm9uZURpcmVjdGl2ZSlcbiAgICAgICAgQE9wdGlvbmFsKClcbiAgICAgICAgQFNraXBTZWxmKClcbiAgICAgICAgcHJpdmF0ZSByZWFkb25seSBkaXJlY3RQYXJlbnRBY3RpdmVab25lOiBUdWlBY3RpdmVab25lRGlyZWN0aXZlIHwgbnVsbCxcbiAgICAgICAgQEluamVjdChOZ1pvbmUpIG5nWm9uZTogTmdab25lLFxuICAgICAgICBASW5qZWN0KFdJTkRPVykgd2luZG93UmVmOiBXaW5kb3csXG4gICAgICAgIEBJbmplY3QoRE9DVU1FTlQpIGRvY3VtZW50UmVmOiBEb2N1bWVudCxcbiAgICApIHtcbiAgICAgICAgbGV0IHNraXBOZXh0Rm9jdXNPdXQgPSBmYWxzZTtcblxuICAgICAgICBpZiAodGhpcy5kaXJlY3RQYXJlbnRBY3RpdmVab25lKSB7XG4gICAgICAgICAgICB0aGlzLmRpcmVjdFBhcmVudEFjdGl2ZVpvbmUuYWRkU3ViQWN0aXZlWm9uZSh0aGlzKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMudHVpQWN0aXZlWm9uZUNoYW5nZSA9IG1lcmdlKFxuICAgICAgICAgICAgdHlwZWRGcm9tRXZlbnQod2luZG93UmVmLCAnZm9jdXNvdXQnKS5waXBlKFxuICAgICAgICAgICAgICAgIGZpbHRlcihldmVudCA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGFjdHVhbFRhcmdldCA9IGdldEFjdHVhbFRhcmdldChldmVudCk7XG5cbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICAgICAgICAgICAgICAgICFza2lwTmV4dEZvY3VzT3V0ICYmXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbnRhaW5zKGFjdHVhbFRhcmdldCkgJiZcbiAgICAgICAgICAgICAgICAgICAgICAgICFpc05hdGl2ZUZvY3VzZWQoYWN0dWFsVGFyZ2V0KSAmJlxuICAgICAgICAgICAgICAgICAgICAgICAgaXNWYWxpZEZvY3Vzb3V0RXZlbnQoZXZlbnQgYXMgYW55KSAmJlxuICAgICAgICAgICAgICAgICAgICAgICAgIXRoaXMuY29udGFpbnMoZXZlbnQucmVsYXRlZFRhcmdldCBhcyBOb2RlIHwgbnVsbClcbiAgICAgICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICB9KSxcbiAgICAgICAgICAgICAgICBtYXBUbyhmYWxzZSksXG4gICAgICAgICAgICApLFxuICAgICAgICAgICAgdHlwZWRGcm9tRXZlbnQod2luZG93UmVmLCAnZm9jdXNpbicpLnBpcGUoXG4gICAgICAgICAgICAgICAgbWFwKGV2ZW50ID0+IHRoaXMuY29udGFpbnMoZ2V0QWN0dWFsVGFyZ2V0KGV2ZW50KSkpLFxuICAgICAgICAgICAgKSxcbiAgICAgICAgICAgIHR5cGVkRnJvbUV2ZW50KHdpbmRvd1JlZiwgJ21vdXNlZG93bicpLnBpcGUoXG4gICAgICAgICAgICAgICAgZmlsdGVyKFxuICAgICAgICAgICAgICAgICAgICBldmVudCA9PlxuICAgICAgICAgICAgICAgICAgICAgICAgZG9jdW1lbnRSZWYuYm9keSA9PT0gZXZlbnQudGFyZ2V0IHx8XG4gICAgICAgICAgICAgICAgICAgICAgICAhaXNOYXRpdmVGb2N1c2VkKGdldEFjdHVhbFRhcmdldChldmVudCkpLFxuICAgICAgICAgICAgICAgICksXG4gICAgICAgICAgICAgICAgc3dpdGNoTWFwKGV2ZW50ID0+IHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgYWN0dWFsVGFyZ2V0ID0gZ2V0QWN0dWFsVGFyZ2V0KGV2ZW50KTtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgdGFyZ2V0SW5ab25lID0gdGhpcy5jb250YWlucyhhY3R1YWxUYXJnZXQpO1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBhY3RpdmVFbGVtZW50ID0gZ2V0TmF0aXZlRm9jdXNlZChkb2N1bWVudFJlZik7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGZvY3VzSW5ab25lID1cbiAgICAgICAgICAgICAgICAgICAgICAgIGFjdGl2ZUVsZW1lbnQgIT09IG51bGwgJiYgdGhpcy5jb250YWlucyhhY3RpdmVFbGVtZW50KTtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgZm9jdXNOb3doZXJlID1cbiAgICAgICAgICAgICAgICAgICAgICAgIGFjdGl2ZUVsZW1lbnQgPT09IG51bGwgfHwgYWN0aXZlRWxlbWVudCA9PT0gZG9jdW1lbnRSZWYuYm9keTtcblxuICAgICAgICAgICAgICAgICAgICAvLyBJZiBkZWZhdWx0IGJlaGF2aW9yIGlzIHByZXZlbnRlZCDigJQgZm9jdXMgZWl0aGVyIHJlbWFpbmVkXG4gICAgICAgICAgICAgICAgICAgIC8vIHdoZXJlIGl0IHdhcyBvciBpdCB3YXMgbW92ZWQgbWFudWFsbHkgc28gd2UganVzdCBjaGVja1xuICAgICAgICAgICAgICAgICAgICAvLyBpZiB0aGUgZm9jdXNlZCBlbGVtZW50IGlzIHdpdGhpbiB0aGUgem9uZSBvciB0YXJnZXQgaXNcbiAgICAgICAgICAgICAgICAgICAgLy8gd2l0aGluIHRoZSB6b25lIGFuZCBmb2N1cyBpcyBub3doZXJlXG4gICAgICAgICAgICAgICAgICAgIGlmIChldmVudC5kZWZhdWx0UHJldmVudGVkKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gb2YoZm9jdXNJblpvbmUgfHwgKGZvY3VzTm93aGVyZSAmJiB0YXJnZXRJblpvbmUpKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgIC8vIElmIG1vdXNlRG93biBoYXBwZW5lZCBpbnNpZGUgdGhlIHpvbmUgYW5kIGZvY3VzIGlzIG91dHNpZGUgd2VcbiAgICAgICAgICAgICAgICAgICAgLy8gcmV0dXJuIHRydWUgaWYgdGFyZ2V0IGlzIG5vdCBmb2N1c2FibGUgb3Igd2FpdCBmb3IgZm9jdXNJblxuICAgICAgICAgICAgICAgICAgICBpZiAodGFyZ2V0SW5ab25lICYmICFmb2N1c0luWm9uZSAmJiBhY3R1YWxUYXJnZXQgaW5zdGFuY2VvZiBFbGVtZW50KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gIWlzTmF0aXZlTW91c2VGb2N1c2FibGUoYWN0dWFsVGFyZ2V0KVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgID8gb2YodHJ1ZSlcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICA6IHR5cGVkRnJvbUV2ZW50KHdpbmRvd1JlZiwgJ2ZvY3VzaW4nKS5waXBlKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRha2UoMSksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWFwVG8odGFyZ2V0SW5ab25lKSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICAvLyBJZiBmb2N1cyBpcyBpbiB0aGUgem9uZSB3ZSB3YWl0IGZvciB0aGUgbmV4dCBmb2N1c091dCBldmVudCBhbmRcbiAgICAgICAgICAgICAgICAgICAgLy8gbWFwIGl0IHRvIGVpdGhlciB0cnVlIG9yIGZhbHNlLCBkZXBlbmRpbmcgb24gaWYgdGhlIG1vdXNlRG93blxuICAgICAgICAgICAgICAgICAgICAvLyB0YXJnZXQgaXMgd2l0aGluIHRoZSB6b25lIG9yIG5vdFxuICAgICAgICAgICAgICAgICAgICBpZiAoZm9jdXNJblpvbmUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEBiYWQgVE9ETzogVGhpbmsgb2YgYSB3YXkgdG8gaGFuZGxlIHRoaXMgd2l0aG91dCBzaWRlLWVmZmVjdHNcbiAgICAgICAgICAgICAgICAgICAgICAgIHNraXBOZXh0Rm9jdXNPdXQgPSB0cnVlO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHlwZWRGcm9tRXZlbnQod2luZG93UmVmLCAnZm9jdXNvdXQnKS5waXBlKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRha2UoMSksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbWFwVG8odGFyZ2V0SW5ab25lKSxcbiAgICAgICAgICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gb2YoZmFsc2UpO1xuICAgICAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgKSxcbiAgICAgICAgKS5waXBlKFxuICAgICAgICAgICAgdGFwKCgpID0+IHtcbiAgICAgICAgICAgICAgICBza2lwTmV4dEZvY3VzT3V0ID0gZmFsc2U7XG4gICAgICAgICAgICB9KSxcbiAgICAgICAgICAgIHN0YXJ0V2l0aChmYWxzZSksXG4gICAgICAgICAgICBkaXN0aW5jdFVudGlsQ2hhbmdlZCgpLFxuICAgICAgICAgICAgc2tpcCgxKSxcbiAgICAgICAgICAgIHR1aVpvbmVPcHRpbWl6ZWQobmdab25lKSxcbiAgICAgICAgKTtcbiAgICB9XG5cbiAgICBuZ09uRGVzdHJveSgpIHtcbiAgICAgICAgaWYgKCEhdGhpcy5kaXJlY3RQYXJlbnRBY3RpdmVab25lKSB7XG4gICAgICAgICAgICB0aGlzLmRpcmVjdFBhcmVudEFjdGl2ZVpvbmUucmVtb3ZlU3ViQWN0aXZlWm9uZSh0aGlzKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghIXRoaXMudHVpQWN0aXZlWm9uZVBhcmVudCkge1xuICAgICAgICAgICAgdGhpcy50dWlBY3RpdmVab25lUGFyZW50LnJlbW92ZVN1YkFjdGl2ZVpvbmUodGhpcyk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBjb250YWlucyhub2RlOiBOb2RlIHwgbnVsbCk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gKFxuICAgICAgICAgICAgISFub2RlICYmXG4gICAgICAgICAgICAodGhpcy5lbGVtZW50Lm5hdGl2ZUVsZW1lbnQuY29udGFpbnMobm9kZSkgfHxcbiAgICAgICAgICAgICAgICB0aGlzLnN1YkFjdGl2ZVpvbmVzLnNvbWUoXG4gICAgICAgICAgICAgICAgICAgIChpdGVtLCBpbmRleCwgYXJyYXkpID0+XG4gICAgICAgICAgICAgICAgICAgICAgICBhcnJheS5pbmRleE9mKGl0ZW0pID09PSBpbmRleCAmJiBpdGVtLmNvbnRhaW5zKG5vZGUpLFxuICAgICAgICAgICAgICAgICkpXG4gICAgICAgICk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBhZGRTdWJBY3RpdmVab25lKGFjdGl2ZVpvbmU6IFR1aUFjdGl2ZVpvbmVEaXJlY3RpdmUpIHtcbiAgICAgICAgdGhpcy5zdWJBY3RpdmVab25lcyA9IFsuLi50aGlzLnN1YkFjdGl2ZVpvbmVzLCBhY3RpdmVab25lXTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHJlbW92ZVN1YkFjdGl2ZVpvbmUoYWN0aXZlWm9uZTogVHVpQWN0aXZlWm9uZURpcmVjdGl2ZSkge1xuICAgICAgICBjb25zdCBpbmRleCA9IHRoaXMuc3ViQWN0aXZlWm9uZXMuZmluZEluZGV4KGl0ZW0gPT4gaXRlbSA9PT0gYWN0aXZlWm9uZSk7XG5cbiAgICAgICAgdGhpcy5zdWJBY3RpdmVab25lcyA9IFtcbiAgICAgICAgICAgIC4uLnRoaXMuc3ViQWN0aXZlWm9uZXMuc2xpY2UoMCwgaW5kZXgpLFxuICAgICAgICAgICAgLi4udGhpcy5zdWJBY3RpdmVab25lcy5zbGljZShpbmRleCArIDEpLFxuICAgICAgICBdO1xuICAgIH1cbn1cblxuLy8gQ2hyb21lIHdvcmthcm91bmQgZm9yIHRyaWdnZXJpbmcgYGZvY3Vzb3V0YCBldmVudCB1cG9uIGVsZW1lbnQgcmVtb3ZhbFxuZnVuY3Rpb24gaXNWYWxpZEZvY3Vzb3V0RXZlbnQoe1xuICAgIHJlbGF0ZWRUYXJnZXQsXG4gICAgc291cmNlQ2FwYWJpbGl0aWVzLFxufTogRm9jdXNFdmVudCAmIHtzb3VyY2VDYXBhYmlsaXRpZXM6IHVua25vd259KTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHNvdXJjZUNhcGFiaWxpdGllcyAhPT0gbnVsbCB8fCByZWxhdGVkVGFyZ2V0ICE9PSBudWxsO1xufVxuIl19