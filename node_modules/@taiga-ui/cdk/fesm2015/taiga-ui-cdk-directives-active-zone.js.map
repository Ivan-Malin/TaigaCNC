{"version":3,"file":"taiga-ui-cdk-directives-active-zone.js","sources":["ng://@taiga-ui/cdk/directives/active-zone/active-zone.directive.ts","ng://@taiga-ui/cdk/directives/active-zone/active-zone.module.ts","ng://@taiga-ui/cdk/directives/active-zone/taiga-ui-cdk-directives-active-zone.ts"],"sourcesContent":["import {DOCUMENT} from '@angular/common';\nimport {\n    Directive,\n    ElementRef,\n    Inject,\n    Input,\n    NgZone,\n    OnDestroy,\n    Optional,\n    Output,\n    SkipSelf,\n} from '@angular/core';\nimport {WINDOW} from '@ng-web-apis/common';\nimport {tuiDefaultProp} from '@taiga-ui/cdk/decorators';\nimport {tuiZoneOptimized, typedFromEvent} from '@taiga-ui/cdk/observables';\nimport {getActualTarget} from '@taiga-ui/cdk/utils/dom';\nimport {\n    getNativeFocused,\n    isNativeFocused,\n    isNativeMouseFocusable,\n} from '@taiga-ui/cdk/utils/focus';\nimport {merge, Observable, of} from 'rxjs';\nimport {\n    distinctUntilChanged,\n    filter,\n    map,\n    mapTo,\n    skip,\n    startWith,\n    switchMap,\n    take,\n    tap,\n} from 'rxjs/operators';\n\n// @dynamic\n@Directive({\n    selector:\n        '[tuiActiveZone]:not(ng-container), [tuiActiveZoneChange]:not(ng-container), [tuiActiveZoneParent]:not(ng-container)',\n    exportAs: 'tuiActiveZone',\n})\nexport class TuiActiveZoneDirective implements OnDestroy {\n    private subActiveZones: ReadonlyArray<TuiActiveZoneDirective> = [];\n\n    private tuiActiveZoneParent: TuiActiveZoneDirective | null = null;\n\n    @Input('tuiActiveZoneParent')\n    @tuiDefaultProp()\n    set tuiActiveZoneParentSetter(zone: TuiActiveZoneDirective | null) {\n        if (this.tuiActiveZoneParent) {\n            this.tuiActiveZoneParent.removeSubActiveZone(this);\n        }\n\n        if (zone) {\n            zone.addSubActiveZone(this);\n        }\n\n        this.tuiActiveZoneParent = zone;\n    }\n\n    @Output()\n    readonly tuiActiveZoneChange: Observable<boolean>;\n\n    constructor(\n        @Inject(ElementRef) private readonly element: ElementRef<Element>,\n        @Inject(TuiActiveZoneDirective)\n        @Optional()\n        @SkipSelf()\n        private readonly directParentActiveZone: TuiActiveZoneDirective | null,\n        @Inject(NgZone) ngZone: NgZone,\n        @Inject(WINDOW) windowRef: Window,\n        @Inject(DOCUMENT) documentRef: Document,\n    ) {\n        let skipNextFocusOut = false;\n\n        if (this.directParentActiveZone) {\n            this.directParentActiveZone.addSubActiveZone(this);\n        }\n\n        this.tuiActiveZoneChange = merge(\n            typedFromEvent(windowRef, 'focusout').pipe(\n                filter(event => {\n                    const actualTarget = getActualTarget(event);\n\n                    return (\n                        !skipNextFocusOut &&\n                        this.contains(actualTarget) &&\n                        !isNativeFocused(actualTarget) &&\n                        isValidFocusoutEvent(event as any) &&\n                        !this.contains(event.relatedTarget as Node | null)\n                    );\n                }),\n                mapTo(false),\n            ),\n            typedFromEvent(windowRef, 'focusin').pipe(\n                map(event => this.contains(getActualTarget(event))),\n            ),\n            typedFromEvent(windowRef, 'mousedown').pipe(\n                filter(\n                    event =>\n                        documentRef.body === event.target ||\n                        !isNativeFocused(getActualTarget(event)),\n                ),\n                switchMap(event => {\n                    const actualTarget = getActualTarget(event);\n                    const targetInZone = this.contains(actualTarget);\n                    const activeElement = getNativeFocused(documentRef);\n                    const focusInZone =\n                        activeElement !== null && this.contains(activeElement);\n                    const focusNowhere =\n                        activeElement === null || activeElement === documentRef.body;\n\n                    // If default behavior is prevented â€” focus either remained\n                    // where it was or it was moved manually so we just check\n                    // if the focused element is within the zone or target is\n                    // within the zone and focus is nowhere\n                    if (event.defaultPrevented) {\n                        return of(focusInZone || (focusNowhere && targetInZone));\n                    }\n\n                    // If mouseDown happened inside the zone and focus is outside we\n                    // return true if target is not focusable or wait for focusIn\n                    if (targetInZone && !focusInZone && actualTarget instanceof Element) {\n                        return !isNativeMouseFocusable(actualTarget)\n                            ? of(true)\n                            : typedFromEvent(windowRef, 'focusin').pipe(\n                                  take(1),\n                                  mapTo(targetInZone),\n                              );\n                    }\n\n                    // If focus is in the zone we wait for the next focusOut event and\n                    // map it to either true or false, depending on if the mouseDown\n                    // target is within the zone or not\n                    if (focusInZone) {\n                        // @bad TODO: Think of a way to handle this without side-effects\n                        skipNextFocusOut = true;\n\n                        return typedFromEvent(windowRef, 'focusout').pipe(\n                            take(1),\n                            mapTo(targetInZone),\n                        );\n                    }\n\n                    return of(false);\n                }),\n            ),\n        ).pipe(\n            tap(() => {\n                skipNextFocusOut = false;\n            }),\n            startWith(false),\n            distinctUntilChanged(),\n            skip(1),\n            tuiZoneOptimized(ngZone),\n        );\n    }\n\n    ngOnDestroy() {\n        if (!!this.directParentActiveZone) {\n            this.directParentActiveZone.removeSubActiveZone(this);\n        }\n\n        if (!!this.tuiActiveZoneParent) {\n            this.tuiActiveZoneParent.removeSubActiveZone(this);\n        }\n    }\n\n    contains(node: Node | null): boolean {\n        return (\n            !!node &&\n            (this.element.nativeElement.contains(node) ||\n                this.subActiveZones.some(\n                    (item, index, array) =>\n                        array.indexOf(item) === index && item.contains(node),\n                ))\n        );\n    }\n\n    private addSubActiveZone(activeZone: TuiActiveZoneDirective) {\n        this.subActiveZones = [...this.subActiveZones, activeZone];\n    }\n\n    private removeSubActiveZone(activeZone: TuiActiveZoneDirective) {\n        const index = this.subActiveZones.findIndex(item => item === activeZone);\n\n        this.subActiveZones = [\n            ...this.subActiveZones.slice(0, index),\n            ...this.subActiveZones.slice(index + 1),\n        ];\n    }\n}\n\n// Chrome workaround for triggering `focusout` event upon element removal\nfunction isValidFocusoutEvent({\n    relatedTarget,\n    sourceCapabilities,\n}: FocusEvent & {sourceCapabilities: unknown}): boolean {\n    return sourceCapabilities !== null || relatedTarget !== null;\n}\n","import {NgModule} from '@angular/core';\nimport {TuiActiveZoneDirective} from './active-zone.directive';\n\n@NgModule({\n    declarations: [TuiActiveZoneDirective],\n    exports: [TuiActiveZoneDirective],\n})\nexport class TuiActiveZoneModule {}\n","/**\n * Generated bundle index. Do not edit.\n */\n\nexport * from './index';\n"],"names":[],"mappings":"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"}