import { CHAR_NO_BREAK_SPACE, getDocumentOrShadowRoot, isNativeFocused, isSafari, tuiAssert, } from '@taiga-ui/cdk';
/**
 * Used to finish a number with zeros to a given precision
 */
export function tuiCreateAutoCorrectedNumberPipe(decimalLimit = 0, decimalSymbol = ',', nativeInput) {
    tuiAssert.assert(Number.isInteger(decimalLimit));
    tuiAssert.assert(decimalLimit >= 0);
    // Guess for which browser I need this :)
    let previousCaret = -1;
    const unlucky = !!nativeInput && isSafari(nativeInput);
    if (nativeInput && unlucky) {
        nativeInput.addEventListener('beforeinput', () => {
            previousCaret = nativeInput.selectionStart || 0;
        });
    }
    return (conformedValue, config) => {
        // remove these hacks after text mask library has changed
        if (nativeInput && unlucky && isNativeFocused(nativeInput)) {
            const caret = calculateSafariCaret(config.previousConformedValue, conformedValue, previousCaret);
            setTimeout(() => {
                nativeInput.setSelectionRange(caret, caret);
            });
        }
        if (nativeInput &&
            nativeInput.ownerDocument !== getDocumentOrShadowRoot(nativeInput) &&
            isNativeFocused(nativeInput) &&
            config.currentCaretPosition) {
            const realCaretPosition = config.currentCaretPosition +
                calculateCaretGap(config.previousConformedValue, conformedValue);
            setTimeout(() => {
                nativeInput.setSelectionRange(realCaretPosition, realCaretPosition);
            });
        }
        if (conformedValue === '' || !decimalLimit) {
            return { value: conformedValue };
        }
        const withDecimalSymbol = addDecimalSymbolIfNeeded(conformedValue, decimalSymbol);
        const decimalPart = withDecimalSymbol.split(decimalSymbol)[1];
        const zeroPaddingSize = decimalLimit - decimalPart.length;
        return {
            value: withDecimalSymbol + '0'.repeat(zeroPaddingSize),
        };
    };
}
function addDecimalSymbolIfNeeded(value, decimalSymbol = ',') {
    return value.indexOf(decimalSymbol) === -1 ? value + decimalSymbol : value;
}
function calculateSafariCaret(previousValue = '', current, previousCaret, decimalSymbol = ',') {
    const tailRegex = new RegExp(`${decimalSymbol}.+`);
    const previousWithoutTail = previousValue.replace(tailRegex, '');
    const currentWithoutTail = current.replace(tailRegex, '');
    const pasteOrCutOperation = Math.abs(previousWithoutTail.length - currentWithoutTail.length) > 2;
    if (pasteOrCutOperation) {
        return current.length;
    }
    if (previousValue.length === current.length) {
        if (previousValue.indexOf(decimalSymbol) <= previousCaret) {
            return calculateChangedTailIndex(previousValue, current);
        }
        return previousWithoutTail === currentWithoutTail
            ? previousCaret - 1
            : previousCaret + 1;
    }
    if (previousValue.length === 0) {
        return 1;
    }
    const changeLength = current.length - previousValue.length;
    return previousCaret + changeLength;
}
function calculateChangedTailIndex(previous, current) {
    for (let i = 0; i < current.length; i++) {
        if (previous[i] !== current[i]) {
            return current[i] === '0' ? i : i + 1;
        }
    }
    return current.length;
}
function calculateCaretGap(previousValue = '', current) {
    const pasteOrCutOperation = Math.abs(previousValue.length - current.length) > 2;
    if (pasteOrCutOperation) {
        return 0;
    }
    const wereSpaces = previousValue.split(CHAR_NO_BREAK_SPACE).length;
    const nowSpaces = current.split(CHAR_NO_BREAK_SPACE).length;
    return nowSpaces - wereSpaces;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3JlYXRlLWF1dG8tY29ycmVjdGVkLW1vbmV5LXBpcGUuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AdGFpZ2EtdWkvY29yZS91dGlscy9tYXNrLyIsInNvdXJjZXMiOlsiY3JlYXRlLWF1dG8tY29ycmVjdGVkLW1vbmV5LXBpcGUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUNILG1CQUFtQixFQUNuQix1QkFBdUIsRUFDdkIsZUFBZSxFQUNmLFFBQVEsRUFDUixTQUFTLEdBQ1osTUFBTSxlQUFlLENBQUM7QUFJdkI7O0dBRUc7QUFDSCxNQUFNLFVBQVUsZ0NBQWdDLENBQzVDLGVBQXVCLENBQUMsRUFDeEIsZ0JBQWtDLEdBQUcsRUFDckMsV0FBOEI7SUFFOUIsU0FBUyxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUM7SUFDakQsU0FBUyxDQUFDLE1BQU0sQ0FBQyxZQUFZLElBQUksQ0FBQyxDQUFDLENBQUM7SUFFcEMseUNBQXlDO0lBQ3pDLElBQUksYUFBYSxHQUFHLENBQUMsQ0FBQyxDQUFDO0lBRXZCLE1BQU0sT0FBTyxHQUFHLENBQUMsQ0FBQyxXQUFXLElBQUksUUFBUSxDQUFDLFdBQVcsQ0FBQyxDQUFDO0lBRXZELElBQUksV0FBVyxJQUFJLE9BQU8sRUFBRTtRQUN4QixXQUFXLENBQUMsZ0JBQWdCLENBQUMsYUFBYSxFQUFFLEdBQUcsRUFBRTtZQUM3QyxhQUFhLEdBQUcsV0FBVyxDQUFDLGNBQWMsSUFBSSxDQUFDLENBQUM7UUFDcEQsQ0FBQyxDQUFDLENBQUM7S0FDTjtJQUVELE9BQU8sQ0FBQyxjQUFjLEVBQUUsTUFBTSxFQUFFLEVBQUU7UUFDOUIseURBQXlEO1FBQ3pELElBQUksV0FBVyxJQUFJLE9BQU8sSUFBSSxlQUFlLENBQUMsV0FBVyxDQUFDLEVBQUU7WUFDeEQsTUFBTSxLQUFLLEdBQUcsb0JBQW9CLENBQzlCLE1BQU0sQ0FBQyxzQkFBc0IsRUFDN0IsY0FBYyxF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Q0FBQyxNQUFNLENBQUM7SUFFM0QsT0FBTyxhQUFhLEdBQUcsWUFBWSxDQUFDO0FBQ3hDLENBQUM7QUFFRCxTQUFTLHlCQUF5QixDQUFDLFFBQWdCLEVBQUUsT0FBZTtJQUNoRSxLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsT0FBTyxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRTtRQUNyQyxJQUFJLFFBQVEsQ0FBQyxDQUFDLENBQUMsS0FBSyxPQUFPLENBQUMsQ0FBQyxDQUFDLEVBQUU7WUFDNUIsT0FBTyxPQUFPLENBQUMsQ0FBQyxDQUFDLEtBQUssR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUM7U0FDekM7S0FDSjtJQUVELE9BQU8sT0FBTyxDQUFDLE1BQU0sQ0FBQztBQUMxQixDQUFDO0FBRUQsU0FBUyxpQkFBaUIsQ0FBQyxnQkFBd0IsRUFBRSxFQUFFLE9BQWU7SUFDbEUsTUFBTSxtQkFBbUIsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLGFBQWEsQ0FBQyxNQUFNLEdBQUcsT0FBTyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUVoRixJQUFJLG1CQUFtQixFQUFFO1FBQ3JCLE9BQU8sQ0FBQyxDQUFDO0tBQ1o7SUFFRCxNQUFNLFVBQVUsR0FBRyxhQUFhLENBQUMsS0FBSyxDQUFDLG1CQUFtQixDQUFDLENBQUMsTUFBTSxDQUFDO0lBQ25FLE1BQU0sU0FBUyxHQUFHLE9BQU8sQ0FBQyxLQUFLLENBQUMsbUJBQW1CLENBQUMsQ0FBQyxNQUFNLENBQUM7SUFFNUQsT0FBTyxTQUFTLEdBQUcsVUFBVSxDQUFDO0FBQ2xDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICAgIENIQVJfTk9fQlJFQUtfU1BBQ0UsXG4gICAgZ2V0RG9jdW1lbnRPclNoYWRvd1Jvb3QsXG4gICAgaXNOYXRpdmVGb2N1c2VkLFxuICAgIGlzU2FmYXJpLFxuICAgIHR1aUFzc2VydCxcbn0gZnJvbSAnQHRhaWdhLXVpL2Nkayc7XG5pbXBvcnQge1R1aVRleHRNYXNrUGlwZUhhbmRsZXJ9IGZyb20gJ0B0YWlnYS11aS9jb3JlL21hc2snO1xuaW1wb3J0IHtUdWlEZWNpbWFsU3ltYm9sfSBmcm9tICdAdGFpZ2EtdWkvY29yZS90eXBlcyc7XG5cbi8qKlxuICogVXNlZCB0byBmaW5pc2ggYSBudW1iZXIgd2l0aCB6ZXJvcyB0byBhIGdpdmVuIHByZWNpc2lvblxuICovXG5leHBvcnQgZnVuY3Rpb24gdHVpQ3JlYXRlQXV0b0NvcnJlY3RlZE51bWJlclBpcGUoXG4gICAgZGVjaW1hbExpbWl0OiBudW1iZXIgPSAwLFxuICAgIGRlY2ltYWxTeW1ib2w6IFR1aURlY2ltYWxTeW1ib2wgPSAnLCcsXG4gICAgbmF0aXZlSW5wdXQ/OiBIVE1MSW5wdXRFbGVtZW50LFxuKTogVHVpVGV4dE1hc2tQaXBlSGFuZGxlciB7XG4gICAgdHVpQXNzZXJ0LmFzc2VydChOdW1iZXIuaXNJbnRlZ2VyKGRlY2ltYWxMaW1pdCkpO1xuICAgIHR1aUFzc2VydC5hc3NlcnQoZGVjaW1hbExpbWl0ID49IDApO1xuXG4gICAgLy8gR3Vlc3MgZm9yIHdoaWNoIGJyb3dzZXIgSSBuZWVkIHRoaXMgOilcbiAgICBsZXQgcHJldmlvdXNDYXJldCA9IC0xO1xuXG4gICAgY29uc3QgdW5sdWNreSA9ICEhbmF0aXZlSW5wdXQgJiYgaXNTYWZhcmkobmF0aXZlSW5wdXQpO1xuXG4gICAgaWYgKG5hdGl2ZUlucHV0ICYmIHVubHVja3kpIHtcbiAgICAgICAgbmF0aXZlSW5wdXQuYWRkRXZlbnRMaXN0ZW5lcignYmVmb3JlaW5wdXQnLCAoKSA9PiB7XG4gICAgICAgICAgICBwcmV2aW91c0NhcmV0ID0gbmF0aXZlSW5wdXQuc2VsZWN0aW9uU3RhcnQgfHwgMDtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIChjb25mb3JtZWRWYWx1ZSwgY29uZmlnKSA9PiB7XG4gICAgICAgIC8vIHJlbW92ZSB0aGVzZSBoYWNrcyBhZnRlciB0ZXh0IG1hc2sgbGlicmFyeSBoYXMgY2hhbmdlZFxuICAgICAgICBpZiAobmF0aXZlSW5wdXQgJiYgdW5sdWNreSAmJiBpc05hdGl2ZUZvY3VzZWQobmF0aXZlSW5wdXQpKSB7XG4gICAgICAgICAgICBjb25zdCBjYXJldCA9IGNhbGN1bGF0ZVNhZmFyaUNhcmV0KFxuICAgICAgICAgICAgICAgIGNvbmZpZy5wcmV2aW91c0NvbmZvcm1lZFZhbHVlLFxuICAgICAgICAgICAgICAgIGNvbmZvcm1lZFZhbHVlLFxuICAgICAgICAgICAgICAgIHByZXZpb3VzQ2FyZXQsXG4gICAgICAgICAgICApO1xuXG4gICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgICAgICAgICBuYXRpdmVJbnB1dC5zZXRTZWxlY3Rpb25SYW5nZShjYXJldCwgY2FyZXQpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoXG4gICAgICAgICAgICBuYXRpdmVJbnB1dCAmJlxuICAgICAgICAgICAgbmF0aXZlSW5wdXQub3duZXJEb2N1bWVudCAhPT0gZ2V0RG9jdW1lbnRPclNoYWRvd1Jvb3QobmF0aXZlSW5wdXQpICYmXG4gICAgICAgICAgICBpc05hdGl2ZUZvY3VzZWQobmF0aXZlSW5wdXQpICYmXG4gICAgICAgICAgICBjb25maWcuY3VycmVudENhcmV0UG9zaXRpb25cbiAgICAgICAgKSB7XG4gICAgICAgICAgICBjb25zdCByZWFsQ2FyZXRQb3NpdGlvbiA9XG4gICAgICAgICAgICAgICAgY29uZmlnLmN1cnJlbnRDYXJldFBvc2l0aW9uICtcbiAgICAgICAgICAgICAgICBjYWxjdWxhdGVDYXJldEdhcChjb25maWcucHJldmlvdXNDb25mb3JtZWRWYWx1ZSwgY29uZm9ybWVkVmFsdWUpO1xuXG4gICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgICAgICAgICBuYXRpdmVJbnB1dC5zZXRTZWxlY3Rpb25SYW5nZShyZWFsQ2FyZXRQb3NpdGlvbiwgcmVhbENhcmV0UG9zaXRpb24pO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoY29uZm9ybWVkVmFsdWUgPT09ICcnIHx8ICFkZWNpbWFsTGltaXQpIHtcbiAgICAgICAgICAgIHJldHVybiB7dmFsdWU6IGNvbmZvcm1lZFZhbHVlfTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IHdpdGhEZWNpbWFsU3ltYm9sID0gYWRkRGVjaW1hbFN5bWJvbElmTmVlZGVkKGNvbmZvcm1lZFZhbHVlLCBkZWNpbWFsU3ltYm9sKTtcbiAgICAgICAgY29uc3QgZGVjaW1hbFBhcnQgPSB3aXRoRGVjaW1hbFN5bWJvbC5zcGxpdChkZWNpbWFsU3ltYm9sKVsxXTtcbiAgICAgICAgY29uc3QgemVyb1BhZGRpbmdTaXplID0gZGVjaW1hbExpbWl0IC0gZGVjaW1hbFBhcnQubGVuZ3RoO1xuXG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICB2YWx1ZTogd2l0aERlY2ltYWxTeW1ib2wgKyAnMCcucmVwZWF0KHplcm9QYWRkaW5nU2l6ZSksXG4gICAgICAgIH07XG4gICAgfTtcbn1cblxuZnVuY3Rpb24gYWRkRGVjaW1hbFN5bWJvbElmTmVlZGVkKFxuICAgIHZhbHVlOiBzdHJpbmcsXG4gICAgZGVjaW1hbFN5bWJvbDogVHVpRGVjaW1hbFN5bWJvbCA9ICcsJyxcbik6IHN0cmluZyB7XG4gICAgcmV0dXJuIHZhbHVlLmluZGV4T2YoZGVjaW1hbFN5bWJvbCkgPT09IC0xID8gdmFsdWUgKyBkZWNpbWFsU3ltYm9sIDogdmFsdWU7XG59XG5cbmZ1bmN0aW9uIGNhbGN1bGF0ZVNhZmFyaUNhcmV0KFxuICAgIHByZXZpb3VzVmFsdWU6IHN0cmluZyA9ICcnLFxuICAgIGN1cnJlbnQ6IHN0cmluZyxcbiAgICBwcmV2aW91c0NhcmV0OiBudW1iZXIsXG4gICAgZGVjaW1hbFN5bWJvbDogc3RyaW5nID0gJywnLFxuKTogbnVtYmVyIHtcbiAgICBjb25zdCB0YWlsUmVnZXggPSBuZXcgUmVnRXhwKGAke2RlY2ltYWxTeW1ib2x9LitgKTtcbiAgICBjb25zdCBwcmV2aW91c1dpdGhvdXRUYWlsID0gcHJldmlvdXNWYWx1ZS5yZXBsYWNlKHRhaWxSZWdleCwgJycpO1xuICAgIGNvbnN0IGN1cnJlbnRXaXRob3V0VGFpbCA9IGN1cnJlbnQucmVwbGFjZSh0YWlsUmVnZXgsICcnKTtcblxuICAgIGNvbnN0IHBhc3RlT3JDdXRPcGVyYXRpb24gPVxuICAgICAgICBNYXRoLmFicyhwcmV2aW91c1dpdGhvdXRUYWlsLmxlbmd0aCAtIGN1cnJlbnRXaXRob3V0VGFpbC5sZW5ndGgpID4gMjtcblxuICAgIGlmIChwYXN0ZU9yQ3V0T3BlcmF0aW9uKSB7XG4gICAgICAgIHJldHVybiBjdXJyZW50Lmxlbmd0aDtcbiAgICB9XG5cbiAgICBpZiAocHJldmlvdXNWYWx1ZS5sZW5ndGggPT09IGN1cnJlbnQubGVuZ3RoKSB7XG4gICAgICAgIGlmIChwcmV2aW91c1ZhbHVlLmluZGV4T2YoZGVjaW1hbFN5bWJvbCkgPD0gcHJldmlvdXNDYXJldCkge1xuICAgICAgICAgICAgcmV0dXJuIGNhbGN1bGF0ZUNoYW5nZWRUYWlsSW5kZXgocHJldmlvdXNWYWx1ZSwgY3VycmVudCk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gcHJldmlvdXNXaXRob3V0VGFpbCA9PT0gY3VycmVudFdpdGhvdXRUYWlsXG4gICAgICAgICAgICA/IHByZXZpb3VzQ2FyZXQgLSAxXG4gICAgICAgICAgICA6IHByZXZpb3VzQ2FyZXQgKyAxO1xuICAgIH1cblxuICAgIGlmIChwcmV2aW91c1ZhbHVlLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICByZXR1cm4gMTtcbiAgICB9XG5cbiAgICBjb25zdCBjaGFuZ2VMZW5ndGggPSBjdXJyZW50Lmxlbmd0aCAtIHByZXZpb3VzVmFsdWUubGVuZ3RoO1xuXG4gICAgcmV0dXJuIHByZXZpb3VzQ2FyZXQgKyBjaGFuZ2VMZW5ndGg7XG59XG5cbmZ1bmN0aW9uIGNhbGN1bGF0ZUNoYW5nZWRUYWlsSW5kZXgocHJldmlvdXM6IHN0cmluZywgY3VycmVudDogc3RyaW5nKTogbnVtYmVyIHtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGN1cnJlbnQubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgaWYgKHByZXZpb3VzW2ldICE9PSBjdXJyZW50W2ldKSB7XG4gICAgICAgICAgICByZXR1cm4gY3VycmVudFtpXSA9PT0gJzAnID8gaSA6IGkgKyAxO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIGN1cnJlbnQubGVuZ3RoO1xufVxuXG5mdW5jdGlvbiBjYWxjdWxhdGVDYXJldEdhcChwcmV2aW91c1ZhbHVlOiBzdHJpbmcgPSAnJywgY3VycmVudDogc3RyaW5nKTogbnVtYmVyIHtcbiAgICBjb25zdCBwYXN0ZU9yQ3V0T3BlcmF0aW9uID0gTWF0aC5hYnMocHJldmlvdXNWYWx1ZS5sZW5ndGggLSBjdXJyZW50Lmxlbmd0aCkgPiAyO1xuXG4gICAgaWYgKHBhc3RlT3JDdXRPcGVyYXRpb24pIHtcbiAgICAgICAgcmV0dXJuIDA7XG4gICAgfVxuXG4gICAgY29uc3Qgd2VyZVNwYWNlcyA9IHByZXZpb3VzVmFsdWUuc3BsaXQoQ0hBUl9OT19CUkVBS19TUEFDRSkubGVuZ3RoO1xuICAgIGNvbnN0IG5vd1NwYWNlcyA9IGN1cnJlbnQuc3BsaXQoQ0hBUl9OT19CUkVBS19TUEFDRSkubGVuZ3RoO1xuXG4gICAgcmV0dXJuIG5vd1NwYWNlcyAtIHdlcmVTcGFjZXM7XG59XG4iXX0=