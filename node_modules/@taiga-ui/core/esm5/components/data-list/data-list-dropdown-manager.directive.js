import { __decorate, __read, __spread } from "tslib";
import { ContentChildren, Directive, ElementRef, } from '@angular/core';
import { EMPTY_QUERY, getClosestKeyboardFocusable, itemsQueryListObservable, preventDefault, setNativeFocused, tuiPure, typedFromEvent, } from '@taiga-ui/cdk';
import { TuiDropdownDirective } from '@taiga-ui/core/directives/dropdown';
import { EMPTY, merge } from 'rxjs';
import { debounceTime, filter, map, mapTo, shareReplay, switchMap, take, tap, } from 'rxjs/operators';
var TuiDataListDropdownManagerDirective = /** @class */ (function () {
    function TuiDataListDropdownManagerDirective() {
        this.dropdowns = EMPTY_QUERY;
        this.elements = EMPTY_QUERY;
    }
    TuiDataListDropdownManagerDirective.prototype.ngAfterViewInit = function () {
        var _this = this;
        this.right$.subscribe(function (index) {
            _this.tryToFocus(index);
        });
        merge(this.immediate$, this.debounce$)
            .pipe(switchMap(function (active) {
            _this.dropdowns.forEach(function (dropdown, index) {
                dropdown.open = index === active;
            });
            var element = _this.elements.toArray()[active];
            var dropdown = _this.dropdowns.toArray()[active];
            if (!element || !dropdown || !dropdown.dropdownBoxRef) {
                return EMPTY;
            }
            var nativeElement = dropdown.dropdownBoxRef.location.nativeElement;
            var mouseEnter$ = typedFromEvent(nativeElement, 'mouseenter').pipe(take(1));
            var esc$ = merge(typedFromEvent(element.nativeElement, 'keydown'), typedFromEvent(nativeElement, 'keydown')).pipe(filter(function (_a) {
                var keyCode = _a.keyCode;
                return keyCode === 27;
            }));
            return merge(mouseEnter$, esc$).pipe(tap(function (event) {
                if (dropdown.dropdownBoxRef) {
                    event.stopPropagation();
                }
                setNativeFocused(element.nativeElement);
                dropdown.open = event instanceof MouseEvent;
            }));
        }))
            .subscribe();
    };
    Object.defineProperty(TuiDataListDropdownManagerDirective.prototype, "elements$", {
        get: function () {
            return itemsQueryListObservable(this.elements).pipe(map(function (array) { return array.map(function (_a) {
                var nativeElement = _a.nativeElement;
                return nativeElement;
            }); }), shareReplay(1));
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(TuiDataListDropdownManagerDirective.prototype, "right$", {
        get: function () {
            return this.elements$.pipe(switchMap(function (elements) {
                return merge.apply(void 0, __spread(elements.map(function (element, index) {
                    return typedFromEvent(element, 'keydown').pipe(filter(function (_a) {
                        var keyCode = _a.keyCode;
                        return keyCode === 39;
                    }), preventDefault(), mapTo(index));
                })));
            }));
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(TuiDataListDropdownManagerDirective.prototype, "immediate$", {
        get: function () {
            return this.elements$.pipe(switchMap(function (elements) {
                return merge.apply(void 0, __spread(elements.map(function (element, index) {
                    return typedFromEvent(element, 'click').pipe(mapTo(index));
                })));
            }));
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(TuiDataListDropdownManagerDirective.prototype, "debounce$", {
        get: function () {
            var _this = this;
            return this.elements$.pipe(switchMap(function (elements) {
                return merge.apply(void 0, __spread(elements.map(function (element, index) {
                    return merge(typedFromEvent(element, 'focus'), typedFromEvent(element, 'blur')).pipe(filter(function (_a) {
                        var relatedTarget = _a.relatedTarget;
                        return _this.notInDropdown(relatedTarget, index);
                    }), map(function (_a) {
                        var type = _a.type;
                        return (type === 'focus' ? index : NaN);
                    }), debounceTime(300));
                })));
            }));
        },
        enumerable: true,
        configurable: true
    });
    TuiDataListDropdownManagerDirective.prototype.notInDropdown = function (element, index) {
        var dropdown = this.dropdowns.toArray()[index];
        return (!dropdown ||
            !dropdown.dropdownBoxRef ||
            !dropdown.dropdownBoxRef.location.nativeElement.contains(element));
    };
    TuiDataListDropdownManagerDirective.prototype.tryToFocus = function (index) {
        var dropdown = this.dropdowns.toArray()[index];
        var content = dropdown &&
            dropdown.dropdownBoxRef &&
            dropdown.dropdownBoxRef.instance.contentElementRef;
        if (!content) {
            return;
        }
        var item = getClosestKeyboardFocusable(content.nativeElement, false, content.nativeElement);
        if (item) {
            setNativeFocused(item);
        }
    };
    __decorate([
        ContentChildren(TuiDropdownDirective, { descendants: true })
    ], TuiDataListDropdownManagerDirective.prototype, "dropdowns", void 0);
    __decorate([
        ContentChildren(TuiDropdownDirective, { read: ElementRef, descendants: true })
    ], TuiDataListDropdownManagerDirective.prototype, "elements", void 0);
    __decorate([
        tuiPure
    ], TuiDataListDropdownManagerDirective.prototype, "elements$", null);
    __decorate([
        tuiPure
    ], TuiDataListDropdownManagerDirective.prototype, "right$", null);
    __decorate([
        tuiPure
    ], TuiDataListDropdownManagerDirective.prototype, "immediate$", null);
    __decorate([
        tuiPure
    ], TuiDataListDropdownManagerDirective.prototype, "debounce$", null);
    TuiDataListDropdownManagerDirective = __decorate([
        Directive({
            selector: 'tui-data-list[tuiDataListDropdownManager]',
        })
    ], TuiDataListDropdownManagerDirective);
    return TuiDataListDropdownManagerDirective;
}());
export { TuiDataListDropdownManagerDirective };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0YS1saXN0LWRyb3Bkb3duLW1hbmFnZXIuZGlyZWN0aXZlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQHRhaWdhLXVpL2NvcmUvY29tcG9uZW50cy9kYXRhLWxpc3QvIiwic291cmNlcyI6WyJkYXRhLWxpc3QtZHJvcGRvd24tbWFuYWdlci5kaXJlY3RpdmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFFSCxlQUFlLEVBQ2YsU0FBUyxFQUNULFVBQVUsR0FFYixNQUFNLGVBQWUsQ0FBQztBQUN2QixPQUFPLEVBQ0gsV0FBVyxFQUNYLDJCQUEyQixFQUMzQix3QkFBd0IsRUFDeEIsY0FBYyxFQUNkLGdCQUFnQixFQUNoQixPQUFPLEVBQ1AsY0FBYyxHQUNqQixNQUFNLGVBQWUsQ0FBQztBQUN2QixPQUFPLEVBQUMsb0JBQW9CLEVBQUMsTUFBTSxvQ0FBb0MsQ0FBQztBQUN4RSxPQUFPLEVBQUMsS0FBSyxFQUFFLEtBQUssRUFBYSxNQUFNLE1BQU0sQ0FBQztBQUM5QyxPQUFPLEVBQ0gsWUFBWSxFQUNaLE1BQU0sRUFDTixHQUFHLEVBQ0gsS0FBSyxFQUNMLFdBQVcsRUFDWCxTQUFTLEVBQ1QsSUFBSSxFQUNKLEdBQUcsR0FDTixNQUFNLGdCQUFnQixDQUFDO0FBS3hCO0lBQUE7UUFFcUIsY0FBUyxHQUFvQyxXQUFXLENBQUM7UUFHekQsYUFBUSxHQUF1QyxXQUFXLENBQUM7SUF3SWhGLENBQUM7SUF0SUcsNkRBQWUsR0FBZjtRQUFBLGlCQXlDQztRQXhDRyxJQUFJLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxVQUFBLEtBQUs7WUFDdkIsS0FBSSxDQUFDLFVBQVUsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUMzQixDQUFDLENBQUMsQ0FBQztRQUVILEtBQUssQ0FBQyxJQUFJLENBQUMsVUFBVSxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUM7YUFDakMsSUFBSSxDQUNELFNBQVMsQ0FBQyxVQUFBLE1BQU07WUFDWixLQUFJLENBQUMsU0FBUyxDQUFDLE9BQU8sQ0FBQyxVQUFDLFFBQVEsRUFBRSxLQUFLO2dCQUNuQyxRQUFRLENBQUMsSUFBSSxHQUFHLEtBQUssS0FBSyxNQUFNLENBQUM7WUFDckMsQ0FBQyxDQUFDLENBQUM7WUFFSCxJQUFNLE9BQU8sR0FBRyxLQUFJLENBQUMsUUFBUSxDQUFDLE9BQU8sRUFBRSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1lBQ2hELElBQU0sUUFBUSxHQUFHLEtBQUksQ0FBQyxTQUFTLENBQUMsT0FBTyxFQUFFLENBQUMsTUFBTSxDQUFDLENBQUM7WUFFbEQsSUFBSSxDQUFDLE9BQU8sSUFBSSxDQUFDLFFBQVEsSUFBSSxDQUFDLFFBQVEsQ0FBQyxjQUFjLEVBQUU7Z0JBQ25ELE9BQU8sS0FBSyxDQUFDO2FBQ2hCO1lBRU0sSUFBQSw4REFBYSxDQUFxQztZQUN6RCxJQUFNLFdBQVcsR0FBRyxjQUFjLENBQUMsYUFBYSxFQUFFLFlBQVksQ0FBQyxDQUFDLElBQUksQ0FDaEUsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUNWLENBQUM7WUFDRixJQUFNLElBQUksR0FBRyxLQUFLLENBQ2QsY0FBYyxDQUFDLE9BQU8sQ0FBQyxhQUFhLEVBQUUsU0FBUyxDQUFDLEVBQ2hELGNBQWMsQ0FBQyxhQUFhLEVBQUUsU0FBUyxDQUFDLENBQzNDLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxVQUFDLEVBQVM7b0JBQVIsb0JBQU87Z0JBQU0sT0FBQSxPQUFPLEtBQUssRUFBRTtZQUFkLENBQWMsQ0FBQyxDQUFDLENBQUM7WUFFOUMsT0FBTyxLQUFLLENBQUMsV0FBVyxFQUFFLElBQUksQ0FBQyxDQUFDLElBQUksQ0FDaEMsR0FBRyxDQUFDLFVBQUEsS0FBSztnQkFDTCxJQUFJLFFBQVEsQ0FBQyxjQUFjLEVBQUU7b0JBQ3pCLEtBQUssQ0FBQyxlQUFlLEVBQUUsQ0FBQztpQkFDM0I7Z0JBRUQsZ0JBQWdCLENBQUMsT0FBTyxDQUFDLGFBQWEsQ0FBQyxDQUFDO2dCQUN4QyxRQUFRLENBQUMsSUFBSSxHQUFHLEtBQUssWUFBWSxVQUFVLENBQUM7WUFDaEQsQ0FBQyxDQUFDLENBQ0wsQ0FBQztRQUNOLENBQUMsQ0FBQyxDQUNMO2FBQ0EsU0FBUyxFQUFFLENBQUM7SUFDckIsQ0FBQztJQUdELHNCQUFZLDBEQUFTO2FBQXJCO1lBQ0ksT0FBTyx3QkFBd0IsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUMsSUFBSSxDQUMvQyxHQUFHLENBQUMsVUFBQSxLQUFLLElBQUksT0FBQSxLQUFLLENBQUMsR0FBRyxDQUFDLFVBQUMsRUFBZTtvQkFBZCxnQ0FBYTtnQkFBTSxPQUFBLGFBQWE7WUFBYixDQUFhLENBQUMsRUFBN0MsQ0FBNkMsQ0FBQyxFQUMzRCxXQUFXLENBQUMsQ0FBQyxDQUFDLENBQ2pCLENBQUM7UUFDTixDQUFDOzs7T0FBQTtJQUdELHNCQUFZLHVEQUFNO2FBQWxCO1lBQ0ksT0FBTyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FDdEIsU0FBUyxDQUFDLFVBQUEsUUFBUTtnQkFDZCxPQUFBLEtBQUssd0JBQ0UsUUFBUSxDQUFDLEdBQUcsQ0FBQyxVQUFDLE9BQU8sRUFBRSxLQUFLO29CQUMzQixPQUFBLGNBQWMsQ0FBQyxPQUFPLEVBQUUsU0FBUyxDQUFDLENBQUMsSUFBSSxDQUNuQyxNQUFNLENBQUMsVUFBQyxFQUFTOzRCQUFSLG9CQUFPO3dCQUFNLE9BQUEsT0FBTyxLQUFLLEVBQUU7b0JBQWQsQ0FBYyxDQUFDLEVBQ3JDLGNBQWMsRUFBRSxFQUNoQixLQUFLLENBQUMsS0FBSyxDQUFDLENBQ2Y7Z0JBSkQsQ0FJQyxDQUNKO1lBUEwsQ0FRQyxDQUNKLENBQ0osQ0FBQztRQUNOLENBQUM7OztPQUFBO0lBR0Qsc0JBQVksMkRBQVU7YUFBdEI7WUFDSSxPQUFPLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUN0QixTQUFTLENBQUMsVUFBQSxRQUFRO2dCQUNkLE9BQUEsS0FBSyx3QkFDRSxRQUFRLENBQUMsR0FBRyxDQUFDLFVBQUMsT0FBTyxFQUFFLEtBQUs7b0JBQzNCLE9BQUEsY0FBYyxDQUFDLE9BQU8sRUFBRSxPQUFPLENBQUMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDO2dCQUFuRCxDQUFtRCxDQUN0RDtZQUhMLENBSUMsQ0FDSixDQUNKLENBQUM7UUFDTixDQUFDOzs7T0FBQTtJQUdELHNCQUFZLDBEQUFTO2FBQXJCO1lBREEsaUJBb0JDO1lBbEJHLE9BQU8sSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQ3RCLFNBQVMsQ0FBQyxVQUFBLFFBQVE7Z0JBQ2QsT0FBQSxLQUFLLHdCQUNFLFFBQVEsQ0FBQyxHQUFHLENBQUMsVUFBQyxPQUFPLEVBQUUsS0FBSztvQkFDM0IsT0FBQSxLQUFLLENBQ0QsY0FBYyxDQUFDLE9BQU8sRUFBRSxPQUFPLENBQUMsRUFDaEMsY0FBYyxDQUFDLE9BQU8sRUFBRSxNQUFNLENBQUMsQ0FDbEMsQ0FBQyxJQUFJLENBQ0YsTUFBTSxDQUFDLFVBQUMsRUFBZTs0QkFBZCxnQ0FBYTt3QkFDbEIsT0FBQSxLQUFJLENBQUMsYUFBYSxDQUFDLGFBQWEsRUFBRSxLQUFLLENBQUM7b0JBQXhDLENBQXdDLENBQzNDLEVBQ0QsR0FBRyxDQUFDLFVBQUMsRUFBTTs0QkFBTCxjQUFJO3dCQUFNLE9BQUEsQ0FBQyxJQUFJLEtBQUssT0FBTyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQztvQkFBaEMsQ0FBZ0MsQ0FBQyxFQUNqRCxZQUFZLENBQUMsR0FBRyxDQUFDLENBQ3BCO2dCQVRELENBU0MsQ0FDSjtZQVpMLENBYUMsQ0FDSixDQUNKLENBQUM7UUFDTixDQUFDOzs7T0FBQTtJQUVPLDJEQUFhLEdBQXJCLFVBQXNCLE9BQTJCLEVBQUUsS0FBYTtRQUM1RCxJQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLE9BQU8sRUFBRSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBRWpELE9BQU8sQ0FDSCxDQUFDLFFBQVE7WUFDVCxDQUFDLFFBQVEsQ0FBQyxjQUFjO1lBQ3hCLENBQUMsUUFBUSxDQUFDLGNBQWMsQ0FBQyxRQUFRLENBQUMsYUFBYSxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsQ0FDcEUsQ0FBQztJQUNOLENBQUM7SUFFTyx3REFBVSxHQUFsQixVQUFtQixLQUFhO1FBQzVCLElBQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsT0FBTyxFQUFFLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDakQsSUFBTSxPQUFPLEdBQ1QsUUFBUTtZQUNSLFFBQVEsQ0FBQyxjQUFjO1lBQ3ZCLFFBQVEsQ0FBQyxjQUFjLENBQUMsUUFBUSxDQUFDLGlCQUFpQixDQUFDO1FBRXZELElBQUksQ0FBQyxPQUFPLEVBQUU7WUFDVixPQUFPO1NBQ1Y7UUFFRCxJQUFNLElBQUksR0FBRywyQkFBMkIsQ0FDcEMsT0FBTyxDQUFDLGFBQWEsRUFDckIsS0FBSyxFQUNMLE9BQU8sQ0FBQyxhQUFhLENBQ3hCLENBQUM7UUFFRixJQUFJLElBQUksRUFBRTtZQUNOLGdCQUFnQixDQUFDLElBQUksQ0FBQyxDQUFDO1NBQzFCO0lBQ0wsQ0FBQztJQTFJRDtRQURDLGVBQWUsQ0FBQyxvQkFBb0IsRUFBRSxFQUFDLFdBQVcsRUFBRSxJQUFJLEVBQUMsQ0FBQzswRUFDZTtJQUcxRTtRQURDLGVBQWUsQ0FBQyxvQkFBb0IsRUFBRSxFQUFDLElBQUksRUFBRSxVQUFVLEVBQUUsV0FBVyxFQUFFLElBQUksRUFBQyxDQUFDO3lFQUNEO0lBOEM1RTtRQURDLE9BQU87d0VBTVA7SUFHRDtRQURDLE9BQU87cUVBZVA7SUFHRDtRQURDLE9BQU87eUVBV1A7SUFHRDtRQURDLE9BQU87d0VBb0JQO0lBNUdRLG1DQUFtQztRQUgvQyxTQUFTLENBQUM7WUFDUCxRQUFRLEVBQUUsMkNBQTJDO1NBQ3hELENBQUM7T0FDVyxtQ0FBbUMsQ0E2SS9DO0lBQUQsMENBQUM7Q0FBQSxBQTdJRCxJQTZJQztTQTdJWSxtQ0FBbUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICAgIEFmdGVyVmlld0luaXQsXG4gICAgQ29udGVudENoaWxkcmVuLFxuICAgIERpcmVjdGl2ZSxcbiAgICBFbGVtZW50UmVmLFxuICAgIFF1ZXJ5TGlzdCxcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQge1xuICAgIEVNUFRZX1FVRVJZLFxuICAgIGdldENsb3Nlc3RLZXlib2FyZEZvY3VzYWJsZSxcbiAgICBpdGVtc1F1ZXJ5TGlzdE9ic2VydmFibGUsXG4gICAgcHJldmVudERlZmF1bHQsXG4gICAgc2V0TmF0aXZlRm9jdXNlZCxcbiAgICB0dWlQdXJlLFxuICAgIHR5cGVkRnJvbUV2ZW50LFxufSBmcm9tICdAdGFpZ2EtdWkvY2RrJztcbmltcG9ydCB7VHVpRHJvcGRvd25EaXJlY3RpdmV9IGZyb20gJ0B0YWlnYS11aS9jb3JlL2RpcmVjdGl2ZXMvZHJvcGRvd24nO1xuaW1wb3J0IHtFTVBUWSwgbWVyZ2UsIE9ic2VydmFibGV9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHtcbiAgICBkZWJvdW5jZVRpbWUsXG4gICAgZmlsdGVyLFxuICAgIG1hcCxcbiAgICBtYXBUbyxcbiAgICBzaGFyZVJlcGxheSxcbiAgICBzd2l0Y2hNYXAsXG4gICAgdGFrZSxcbiAgICB0YXAsXG59IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcblxuQERpcmVjdGl2ZSh7XG4gICAgc2VsZWN0b3I6ICd0dWktZGF0YS1saXN0W3R1aURhdGFMaXN0RHJvcGRvd25NYW5hZ2VyXScsXG59KVxuZXhwb3J0IGNsYXNzIFR1aURhdGFMaXN0RHJvcGRvd25NYW5hZ2VyRGlyZWN0aXZlIGltcGxlbWVudHMgQWZ0ZXJWaWV3SW5pdCB7XG4gICAgQENvbnRlbnRDaGlsZHJlbihUdWlEcm9wZG93bkRpcmVjdGl2ZSwge2Rlc2NlbmRhbnRzOiB0cnVlfSlcbiAgICBwcml2YXRlIHJlYWRvbmx5IGRyb3Bkb3duczogUXVlcnlMaXN0PFR1aURyb3Bkb3duRGlyZWN0aXZlPiA9IEVNUFRZX1FVRVJZO1xuXG4gICAgQENvbnRlbnRDaGlsZHJlbihUdWlEcm9wZG93bkRpcmVjdGl2ZSwge3JlYWQ6IEVsZW1lbnRSZWYsIGRlc2NlbmRhbnRzOiB0cnVlfSlcbiAgICBwcml2YXRlIHJlYWRvbmx5IGVsZW1lbnRzOiBRdWVyeUxpc3Q8RWxlbWVudFJlZjxIVE1MRWxlbWVudD4+ID0gRU1QVFlfUVVFUlk7XG5cbiAgICBuZ0FmdGVyVmlld0luaXQoKSB7XG4gICAgICAgIHRoaXMucmlnaHQkLnN1YnNjcmliZShpbmRleCA9PiB7XG4gICAgICAgICAgICB0aGlzLnRyeVRvRm9jdXMoaW5kZXgpO1xuICAgICAgICB9KTtcblxuICAgICAgICBtZXJnZSh0aGlzLmltbWVkaWF0ZSQsIHRoaXMuZGVib3VuY2UkKVxuICAgICAgICAgICAgLnBpcGUoXG4gICAgICAgICAgICAgICAgc3dpdGNoTWFwKGFjdGl2ZSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZHJvcGRvd25zLmZvckVhY2goKGRyb3Bkb3duLCBpbmRleCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgZHJvcGRvd24ub3BlbiA9IGluZGV4ID09PSBhY3RpdmU7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGVsZW1lbnQgPSB0aGlzLmVsZW1lbnRzLnRvQXJyYXkoKVthY3RpdmVdO1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBkcm9wZG93biA9IHRoaXMuZHJvcGRvd25zLnRvQXJyYXkoKVthY3RpdmVdO1xuXG4gICAgICAgICAgICAgICAgICAgIGlmICghZWxlbWVudCB8fCAhZHJvcGRvd24gfHwgIWRyb3Bkb3duLmRyb3Bkb3duQm94UmVmKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gRU1QVFk7XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICBjb25zdCB7bmF0aXZlRWxlbWVudH0gPSBkcm9wZG93bi5kcm9wZG93bkJveFJlZi5sb2NhdGlvbjtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgbW91c2VFbnRlciQgPSB0eXBlZEZyb21FdmVudChuYXRpdmVFbGVtZW50LCAnbW91c2VlbnRlcicpLnBpcGUoXG4gICAgICAgICAgICAgICAgICAgICAgICB0YWtlKDEpLFxuICAgICAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBlc2MkID0gbWVyZ2UoXG4gICAgICAgICAgICAgICAgICAgICAgICB0eXBlZEZyb21FdmVudChlbGVtZW50Lm5hdGl2ZUVsZW1lbnQsICdrZXlkb3duJyksXG4gICAgICAgICAgICAgICAgICAgICAgICB0eXBlZEZyb21FdmVudChuYXRpdmVFbGVtZW50LCAna2V5ZG93bicpLFxuICAgICAgICAgICAgICAgICAgICApLnBpcGUoZmlsdGVyKCh7a2V5Q29kZX0pID0+IGtleUNvZGUgPT09IDI3KSk7XG5cbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG1lcmdlKG1vdXNlRW50ZXIkLCBlc2MkKS5waXBlKFxuICAgICAgICAgICAgICAgICAgICAgICAgdGFwKGV2ZW50ID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZHJvcGRvd24uZHJvcGRvd25Cb3hSZWYpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc2V0TmF0aXZlRm9jdXNlZChlbGVtZW50Lm5hdGl2ZUVsZW1lbnQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRyb3Bkb3duLm9wZW4gPSBldmVudCBpbnN0YW5jZW9mIE1vdXNlRXZlbnQ7XG4gICAgICAgICAgICAgICAgICAgICAgICB9KSxcbiAgICAgICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICB9KSxcbiAgICAgICAgICAgIClcbiAgICAgICAgICAgIC5zdWJzY3JpYmUoKTtcbiAgICB9XG5cbiAgICBAdHVpUHVyZVxuICAgIHByaXZhdGUgZ2V0IGVsZW1lbnRzJCgpOiBPYnNlcnZhYmxlPFJlYWRvbmx5QXJyYXk8SFRNTEVsZW1lbnQ+PiB7XG4gICAgICAgIHJldHVybiBpdGVtc1F1ZXJ5TGlzdE9ic2VydmFibGUodGhpcy5lbGVtZW50cykucGlwZShcbiAgICAgICAgICAgIG1hcChhcnJheSA9PiBhcnJheS5tYXAoKHtuYXRpdmVFbGVtZW50fSkgPT4gbmF0aXZlRWxlbWVudCkpLFxuICAgICAgICAgICAgc2hhcmVSZXBsYXkoMSksXG4gICAgICAgICk7XG4gICAgfVxuXG4gICAgQHR1aVB1cmVcbiAgICBwcml2YXRlIGdldCByaWdodCQoKTogT2JzZXJ2YWJsZTxudW1iZXI+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZWxlbWVudHMkLnBpcGUoXG4gICAgICAgICAgICBzd2l0Y2hNYXAoZWxlbWVudHMgPT5cbiAgICAgICAgICAgICAgICBtZXJnZShcbiAgICAgICAgICAgICAgICAgICAgLi4uZWxlbWVudHMubWFwKChlbGVtZW50LCBpbmRleCkgPT5cbiAgICAgICAgICAgICAgICAgICAgICAgIHR5cGVkRnJvbUV2ZW50KGVsZW1lbnQsICdrZXlkb3duJykucGlwZShcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaWx0ZXIoKHtrZXlDb2RlfSkgPT4ga2V5Q29kZSA9PT0gMzkpLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByZXZlbnREZWZhdWx0KCksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbWFwVG8oaW5kZXgpLFxuICAgICAgICAgICAgICAgICAgICAgICAgKSxcbiAgICAgICAgICAgICAgICAgICAgKSxcbiAgICAgICAgICAgICAgICApLFxuICAgICAgICAgICAgKSxcbiAgICAgICAgKTtcbiAgICB9XG5cbiAgICBAdHVpUHVyZVxuICAgIHByaXZhdGUgZ2V0IGltbWVkaWF0ZSQoKTogT2JzZXJ2YWJsZTxudW1iZXI+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZWxlbWVudHMkLnBpcGUoXG4gICAgICAgICAgICBzd2l0Y2hNYXAoZWxlbWVudHMgPT5cbiAgICAgICAgICAgICAgICBtZXJnZShcbiAgICAgICAgICAgICAgICAgICAgLi4uZWxlbWVudHMubWFwKChlbGVtZW50LCBpbmRleCkgPT5cbiAgICAgICAgICAgICAgICAgICAgICAgIHR5cGVkRnJvbUV2ZW50KGVsZW1lbnQsICdjbGljaycpLnBpcGUobWFwVG8oaW5kZXgpKSxcbiAgICAgICAgICAgICAgICAgICAgKSxcbiAgICAgICAgICAgICAgICApLFxuICAgICAgICAgICAgKSxcbiAgICAgICAgKTtcbiAgICB9XG5cbiAgICBAdHVpUHVyZVxuICAgIHByaXZhdGUgZ2V0IGRlYm91bmNlJCgpOiBPYnNlcnZhYmxlPG51bWJlcj4ge1xuICAgICAgICByZXR1cm4gdGhpcy5lbGVtZW50cyQucGlwZShcbiAgICAgICAgICAgIHN3aXRjaE1hcChlbGVtZW50cyA9PlxuICAgICAgICAgICAgICAgIG1lcmdlKFxuICAgICAgICAgICAgICAgICAgICAuLi5lbGVtZW50cy5tYXAoKGVsZW1lbnQsIGluZGV4KSA9PlxuICAgICAgICAgICAgICAgICAgICAgICAgbWVyZ2UoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZWRGcm9tRXZlbnQoZWxlbWVudCwgJ2ZvY3VzJyksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZWRGcm9tRXZlbnQoZWxlbWVudCwgJ2JsdXInKSxcbiAgICAgICAgICAgICAgICAgICAgICAgICkucGlwZShcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaWx0ZXIoKHtyZWxhdGVkVGFyZ2V0fSkgPT5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5ub3RJbkRyb3Bkb3duKHJlbGF0ZWRUYXJnZXQsIGluZGV4KSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICApLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1hcCgoe3R5cGV9KSA9PiAodHlwZSA9PT0gJ2ZvY3VzJyA/IGluZGV4IDogTmFOKSksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVib3VuY2VUaW1lKDMwMCksXG4gICAgICAgICAgICAgICAgICAgICAgICApLFxuICAgICAgICAgICAgICAgICAgICApLFxuICAgICAgICAgICAgICAgICksXG4gICAgICAgICAgICApLFxuICAgICAgICApO1xuICAgIH1cblxuICAgIHByaXZhdGUgbm90SW5Ecm9wZG93bihlbGVtZW50OiBFdmVudFRhcmdldCB8IG51bGwsIGluZGV4OiBudW1iZXIpOiBib29sZWFuIHtcbiAgICAgICAgY29uc3QgZHJvcGRvd24gPSB0aGlzLmRyb3Bkb3ducy50b0FycmF5KClbaW5kZXhdO1xuXG4gICAgICAgIHJldHVybiAoXG4gICAgICAgICAgICAhZHJvcGRvd24gfHxcbiAgICAgICAgICAgICFkcm9wZG93bi5kcm9wZG93bkJveFJlZiB8fFxuICAgICAgICAgICAgIWRyb3Bkb3duLmRyb3Bkb3duQm94UmVmLmxvY2F0aW9uLm5hdGl2ZUVsZW1lbnQuY29udGFpbnMoZWxlbWVudClcbiAgICAgICAgKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHRyeVRvRm9jdXMoaW5kZXg6IG51bWJlcikge1xuICAgICAgICBjb25zdCBkcm9wZG93biA9IHRoaXMuZHJvcGRvd25zLnRvQXJyYXkoKVtpbmRleF07XG4gICAgICAgIGNvbnN0IGNvbnRlbnQgPVxuICAgICAgICAgICAgZHJvcGRvd24gJiZcbiAgICAgICAgICAgIGRyb3Bkb3duLmRyb3Bkb3duQm94UmVmICYmXG4gICAgICAgICAgICBkcm9wZG93bi5kcm9wZG93bkJveFJlZi5pbnN0YW5jZS5jb250ZW50RWxlbWVudFJlZjtcblxuICAgICAgICBpZiAoIWNvbnRlbnQpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IGl0ZW0gPSBnZXRDbG9zZXN0S2V5Ym9hcmRGb2N1c2FibGUoXG4gICAgICAgICAgICBjb250ZW50Lm5hdGl2ZUVsZW1lbnQsXG4gICAgICAgICAgICBmYWxzZSxcbiAgICAgICAgICAgIGNvbnRlbnQubmF0aXZlRWxlbWVudCxcbiAgICAgICAgKTtcblxuICAgICAgICBpZiAoaXRlbSkge1xuICAgICAgICAgICAgc2V0TmF0aXZlRm9jdXNlZChpdGVtKTtcbiAgICAgICAgfVxuICAgIH1cbn1cbiJdfQ==