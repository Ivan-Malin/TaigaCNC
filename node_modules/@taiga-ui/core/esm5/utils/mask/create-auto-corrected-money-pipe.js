import { CHAR_NO_BREAK_SPACE, getDocumentOrShadowRoot, isNativeFocused, isSafari, tuiAssert, } from '@taiga-ui/cdk';
/**
 * Used to finish a number with zeros to a given precision
 */
export function tuiCreateAutoCorrectedNumberPipe(decimalLimit, decimalSymbol, nativeInput) {
    if (decimalLimit === void 0) { decimalLimit = 0; }
    if (decimalSymbol === void 0) { decimalSymbol = ','; }
    tuiAssert.assert(Number.isInteger(decimalLimit));
    tuiAssert.assert(decimalLimit >= 0);
    // Guess for which browser I need this :)
    var previousCaret = -1;
    var unlucky = !!nativeInput && isSafari(nativeInput);
    if (nativeInput && unlucky) {
        nativeInput.addEventListener('beforeinput', function () {
            previousCaret = nativeInput.selectionStart || 0;
        });
    }
    return function (conformedValue, config) {
        // remove these hacks after text mask library has changed
        if (nativeInput && unlucky && isNativeFocused(nativeInput)) {
            var caret_1 = calculateSafariCaret(config.previousConformedValue, conformedValue, previousCaret);
            setTimeout(function () {
                nativeInput.setSelectionRange(caret_1, caret_1);
            });
        }
        if (nativeInput &&
            nativeInput.ownerDocument !== getDocumentOrShadowRoot(nativeInput) &&
            isNativeFocused(nativeInput) &&
            config.currentCaretPosition) {
            var realCaretPosition_1 = config.currentCaretPosition +
                calculateCaretGap(config.previousConformedValue, conformedValue);
            setTimeout(function () {
                nativeInput.setSelectionRange(realCaretPosition_1, realCaretPosition_1);
            });
        }
        if (conformedValue === '' || !decimalLimit) {
            return { value: conformedValue };
        }
        var withDecimalSymbol = addDecimalSymbolIfNeeded(conformedValue, decimalSymbol);
        var decimalPart = withDecimalSymbol.split(decimalSymbol)[1];
        var zeroPaddingSize = decimalLimit - decimalPart.length;
        return {
            value: withDecimalSymbol + '0'.repeat(zeroPaddingSize),
        };
    };
}
function addDecimalSymbolIfNeeded(value, decimalSymbol) {
    if (decimalSymbol === void 0) { decimalSymbol = ','; }
    return value.indexOf(decimalSymbol) === -1 ? value + decimalSymbol : value;
}
function calculateSafariCaret(previousValue, current, previousCaret, decimalSymbol) {
    if (previousValue === void 0) { previousValue = ''; }
    if (decimalSymbol === void 0) { decimalSymbol = ','; }
    var tailRegex = new RegExp(decimalSymbol + ".+");
    var previousWithoutTail = previousValue.replace(tailRegex, '');
    var currentWithoutTail = current.replace(tailRegex, '');
    var pasteOrCutOperation = Math.abs(previousWithoutTail.length - currentWithoutTail.length) > 2;
    if (pasteOrCutOperation) {
        return current.length;
    }
    if (previousValue.length === current.length) {
        if (previousValue.indexOf(decimalSymbol) <= previousCaret) {
            return calculateChangedTailIndex(previousValue, current);
        }
        return previousWithoutTail === currentWithoutTail
            ? previousCaret - 1
            : previousCaret + 1;
    }
    if (previousValue.length === 0) {
        return 1;
    }
    var changeLength = current.length - previousValue.length;
    return previousCaret + changeLength;
}
function calculateChangedTailIndex(previous, current) {
    for (var i = 0; i < current.length; i++) {
        if (previous[i] !== current[i]) {
            return current[i] === '0' ? i : i + 1;
        }
    }
    return current.length;
}
function calculateCaretGap(previousValue, current) {
    if (previousValue === void 0) { previousValue = ''; }
    var pasteOrCutOperation = Math.abs(previousValue.length - current.length) > 2;
    if (pasteOrCutOperation) {
        return 0;
    }
    var wereSpaces = previousValue.split(CHAR_NO_BREAK_SPACE).length;
    var nowSpaces = current.split(CHAR_NO_BREAK_SPACE).length;
    return nowSpaces - wereSpaces;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3JlYXRlLWF1dG8tY29ycmVjdGVkLW1vbmV5LXBpcGUuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AdGFpZ2EtdWkvY29yZS91dGlscy9tYXNrLyIsInNvdXJjZXMiOlsiY3JlYXRlLWF1dG8tY29ycmVjdGVkLW1vbmV5LXBpcGUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUNILG1CQUFtQixFQUNuQix1QkFBdUIsRUFDdkIsZUFBZSxFQUNmLFFBQVEsRUFDUixTQUFTLEdBQ1osTUFBTSxlQUFlLENBQUM7QUFJdkI7O0dBRUc7QUFDSCxNQUFNLFVBQVUsZ0NBQWdDLENBQzVDLFlBQXdCLEVBQ3hCLGFBQXFDLEVBQ3JDLFdBQThCO0lBRjlCLDZCQUFBLEVBQUEsZ0JBQXdCO0lBQ3hCLDhCQUFBLEVBQUEsbUJBQXFDO0lBR3JDLFNBQVMsQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDO0lBQ2pELFNBQVMsQ0FBQyxNQUFNLENBQUMsWUFBWSxJQUFJLENBQUMsQ0FBQyxDQUFDO0lBRXBDLHlDQUF5QztJQUN6QyxJQUFJLGFBQWEsR0FBRyxDQUFDLENBQUMsQ0FBQztJQUV2QixJQUFNLE9BQU8sR0FBRyxDQUFDLENBQUMsV0FBVyxJQUFJLFFBQVEsQ0FBQyxXQUFXLENBQUMsQ0FBQztJQUV2RCxJQUFJLFdBQVcsSUFBSSxPQUFPLEVBQUU7UUFDeEIsV0FBVyxDQUFDLGdCQUFnQixDQUFDLGFBQWEsRUFBRTtZQUN4QyxhQUFhLEdBQUcsV0FBVyxDQUFDLGNBQWMsSUFBSSxDQUFDLENBQUM7UUFDcEQsQ0FBQyxDQUFDLENBQUM7S0FDTjtJQUVELE9BQU8sVUFBQyxjQUFjLEVBQUUsTUFBTTtRQUMxQix5REFBeUQ7UUFDekQsSUFBSSxXQUFXLElBQUksT0FBTyxJQUFJLGVBQWUsQ0FBQyxXQUFXLENBQUMsRUFBRTtZQUN4RCxJQUFNLE9BQUssR0FBRyxvQkFBb0IsQ0FDOUIsTUFBTSxDQUFDLHNCQUFzQixFQUM3QixjQUFjLEVBQ2QsYUFBYSxDQUNoQixDQUFDO1lBRUYsVUFBVSxDQUFDO2dCQUNQLFdBQVcsQ0FBQyxpQkFBaUIsQ0FBQyxPQUFLLEVBQUUsT0FBSyxDQUFDLENBQUM7WUFDaEQsQ0FBQyxDQUFDLENBQUM7U0FDTjtRQUVELElBQ0ksV0FBVztZQUNYLFdBQVcsQ0FBQyxhQUFhLEtBQUssdUJBQXVCLENBQUMsV0FBVyxDQUFDO1lBQ2xFLGVBQWUsQ0FBQyxXQUFXLENBQUM7WUFDNUIsTUFBTSxDQUFDLG9CQUFvQixFQUM3QjtZQUNFLElBQU0sbUJBQWlCLEdBQ25CLE1BQU0sQ0FBQyxvQkFBb0I7Z0JBQzNCLGlCQUFpQixDQUFDLE1BQU0sQ0FBQyxzQkFBc0IsRUFBRSxjQUFjLENBQUMsQ0FBQztZQUVyRSxVQUFVLENBQUM7Z0JBQ1AsV0FBVyxDQUFDLGlCQUFpQixDQUFDLG1CQUFpQixFQUFFLG1CQUFpQixDQUFDLENBQUM7WUFDeEUsQ0FBQyxDQUFDLENBQUM7U0FDTjtRQUVELElBQUksY0FBYyxLQUFLLEVBQUUsSUFBSSxDQUFDLFlBQVksRUFBRTtZQUN4QyxPQUFPLEVBQUMsS0FBSyxFQUFFLGNBQWMsRUFBQyxDQUFDO1NBQ2xDO1FBRUQsSUFBTSxpQkFBaUIsR0FBRyx3QkFBd0IsQ0FBQyxjQUFjLEVBQUUsYUFBYSxDQUFDLENBQUM7UUFDbEYsSUFBTSxXQUFXLEdBQUcsaUJBQWlCLENBQUMsS0FBSyxDQUFDLGFBQWEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQzlELElBQU0sZUFBZSxHQUFHLFlBQVksR0FBRyxXQUFXLENBQUMsTUFBTSxDQUFDO1FBRTFELE9BQU87WUFDSCxLQUFLLEVBQUUsaUJBQWlCLEdBQUcsR0FBRyxDQUFDLE1BQU0sQ0FBQyxlQUFlLENBQUM7U0FDekQsQ0FBQztJQUNOLENBQUMsQ0FBQztBQUNOLENBQUM7QUFFRCxTQUFTLHdCQUF3QixDQUM3QixLQUFhLEVBQ2IsYUFBcUM7SUFBckMsOEJBQUEsRUFBQSxtQkFBcUM7SUFFckMsT0FBTyxLQUFLLENBQUMsT0FBTyxDQUFDLGFBQWEsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLEdBQUcsYUFBYSxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUM7QUFDL0UsQ0FBQztBQUVELFNBQVMsb0JBQW9CLENBQ3pCLGFBQTBCLEVBQzFCLE9BQWUsRUFDZixhQUFxQixFQUNyQixhQUEyQjtJQUgzQiw4QkFBQSxFQUFBLGtCQUEwQjtJQUcxQiw4QkFBQSxFQUFBLG1CQUEyQjtJQUUzQixJQUFNLFNBQVMsR0FBRyxJQUFJLE1BQU0sQ0FBSSxhQUFhLE9BQUksQ0FBQyxDQUFDO0lBQ25ELElBQU0sbUJBQW1CLEdBQUcsYUFBYSxDQUFDLE9BQU8sQ0FBQyxTQUFTLEVBQUUsRUFBRSxDQUFDLENBQUM7SUFDakUsSUFBTSxrQkFBa0IsR0FBRyxPQUFPLENBQUMsT0FBTyxDQUFDLFNBQVMsRUFBRSxFQUFFLENBQUMsQ0FBQztJQUUxRCxJQUFNLG1CQUFtQixHQUNyQixJQUFJLENBQUMsR0FBRyxDQUFDLG1CQUFtQixDQUFDLE1BQU0sR0FBRyxrQkFBa0IsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7SUFFekUsSUFBSSxtQkFBbUIsRUFBRTtRQUNyQixPQUFPLE9BQU8sQ0FBQyxNQUFNLENBQUM7S0FDekI7SUFFRCxJQUFJLGFBQWEsQ0FBQyxNQUFNLEtBQUssT0FBTyxDQUFDLE1BQU0sRUFBRTtRQUN6QyxJQUFJLGFBQWEsQ0FBQyxPQUFPLENBQUMsYUFBYSxDQUFDLElBQUksYUFBYSxFQUFFO1lBQ3ZELE9BQU8seUJBQXlCLENBQUMsYUFBYSxFQUFFLE9BQU8sQ0FBQyxDQUFDO1NBQzVEO1FBRUQsT0FBTyxtQkFBbUIsS0FBSyxrQkFBa0I7WUFDN0MsQ0FBQyxDQUFDLGFBQWEsR0FBRyxDQUFDO1lBQ25CLENBQUMsQ0FBQyxhQUFhLEdBQUcsQ0FBQyxDQUFDO0tBQzNCO0lBRUQsSUFBSSxhQUFhLENBQUMsTUFBTSxLQUFLLENBQUMsRUFBRTtRQUM1QixPQUFPLENBQUMsQ0FBQztLQUNaO0lBRUQsSUFBTSxZQUFZLEdBQUcsT0FBTyxDQUFDLE1BQU0sR0FBRyxhQUFhLENBQUMsTUFBTSxDQUFDO0lBRTNELE9BQU8sYUFBYSxHQUFHLFlBQVksQ0FBQztBQUN4QyxDQUFDO0FBRUQsU0FBUyx5QkFBeUIsQ0FBQyxRQUFnQixFQUFFLE9BQWU7SUFDaEUsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLE9BQU8sQ0FBQyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUU7UUFDckMsSUFBSSxRQUFRLENBQUMsQ0FBQyxDQUFDLEtBQUssT0FBTyxDQUFDLENBQUMsQ0FBQyxFQUFFO1lBQzVCLE9BQU8sT0FBTyxDQUFDLENBQUMsQ0FBQyxLQUFLLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1NBQ3pDO0tBQ0o7SUFFRCxPQUFPLE9BQU8sQ0FBQyxNQUFNLENBQUM7QUFDMUIsQ0FBQztBQUVELFNBQVMsaUJBQWlCLENBQUMsYUFBMEIsRUFBRSxPQUFlO0lBQTNDLDhCQUFBLEVBQUEsa0JBQTBCO0lBQ2pELElBQU0sbUJBQW1CLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxhQUFhLENBQUMsTUFBTSxHQUFHLE9BQU8sQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7SUFFaEYsSUFBSSxtQkFBbUIsRUFBRTtRQUNyQixPQUFPLENBQUMsQ0FBQztLQUNaO0lBRUQsSUFBTSxVQUFVLEdBQUcsYUFBYSxDQUFDLEtBQUssQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDLE1BQU0sQ0FBQztJQUNuRSxJQUFNLFNBQVMsR0FBRyxPQUFPLENBQUMsS0FBSyxDQUFDLG1CQUFtQixDQUFDLENBQUMsTUFBTSxDQUFDO0lBRTVELE9BQU8sU0FBUyxHQUFHLFVBQVUsQ0FBQztBQUNsQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgICBDSEFSX05PX0JSRUFLX1NQQUNFLFxuICAgIGdldERvY3VtZW50T3JTaGFkb3dSb290LFxuICAgIGlzTmF0aXZlRm9jdXNlZCxcbiAgICBpc1NhZmFyaSxcbiAgICB0dWlBc3NlcnQsXG59IGZyb20gJ0B0YWlnYS11aS9jZGsnO1xuaW1wb3J0IHtUdWlUZXh0TWFza1BpcGVIYW5kbGVyfSBmcm9tICdAdGFpZ2EtdWkvY29yZS9tYXNrJztcbmltcG9ydCB7VHVpRGVjaW1hbFN5bWJvbH0gZnJvbSAnQHRhaWdhLXVpL2NvcmUvdHlwZXMnO1xuXG4vKipcbiAqIFVzZWQgdG8gZmluaXNoIGEgbnVtYmVyIHdpdGggemVyb3MgdG8gYSBnaXZlbiBwcmVjaXNpb25cbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIHR1aUNyZWF0ZUF1dG9Db3JyZWN0ZWROdW1iZXJQaXBlKFxuICAgIGRlY2ltYWxMaW1pdDogbnVtYmVyID0gMCxcbiAgICBkZWNpbWFsU3ltYm9sOiBUdWlEZWNpbWFsU3ltYm9sID0gJywnLFxuICAgIG5hdGl2ZUlucHV0PzogSFRNTElucHV0RWxlbWVudCxcbik6IFR1aVRleHRNYXNrUGlwZUhhbmRsZXIge1xuICAgIHR1aUFzc2VydC5hc3NlcnQoTnVtYmVyLmlzSW50ZWdlcihkZWNpbWFsTGltaXQpKTtcbiAgICB0dWlBc3NlcnQuYXNzZXJ0KGRlY2ltYWxMaW1pdCA+PSAwKTtcblxuICAgIC8vIEd1ZXNzIGZvciB3aGljaCBicm93c2VyIEkgbmVlZCB0aGlzIDopXG4gICAgbGV0IHByZXZpb3VzQ2FyZXQgPSAtMTtcblxuICAgIGNvbnN0IHVubHVja3kgPSAhIW5hdGl2ZUlucHV0ICYmIGlzU2FmYXJpKG5hdGl2ZUlucHV0KTtcblxuICAgIGlmIChuYXRpdmVJbnB1dCAmJiB1bmx1Y2t5KSB7XG4gICAgICAgIG5hdGl2ZUlucHV0LmFkZEV2ZW50TGlzdGVuZXIoJ2JlZm9yZWlucHV0JywgKCkgPT4ge1xuICAgICAgICAgICAgcHJldmlvdXNDYXJldCA9IG5hdGl2ZUlucHV0LnNlbGVjdGlvblN0YXJ0IHx8IDA7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHJldHVybiAoY29uZm9ybWVkVmFsdWUsIGNvbmZpZykgPT4ge1xuICAgICAgICAvLyByZW1vdmUgdGhlc2UgaGFja3MgYWZ0ZXIgdGV4dCBtYXNrIGxpYnJhcnkgaGFzIGNoYW5nZWRcbiAgICAgICAgaWYgKG5hdGl2ZUlucHV0ICYmIHVubHVja3kgJiYgaXNOYXRpdmVGb2N1c2VkKG5hdGl2ZUlucHV0KSkge1xuICAgICAgICAgICAgY29uc3QgY2FyZXQgPSBjYWxjdWxhdGVTYWZhcmlDYXJldChcbiAgICAgICAgICAgICAgICBjb25maWcucHJldmlvdXNDb25mb3JtZWRWYWx1ZSxcbiAgICAgICAgICAgICAgICBjb25mb3JtZWRWYWx1ZSxcbiAgICAgICAgICAgICAgICBwcmV2aW91c0NhcmV0LFxuICAgICAgICAgICAgKTtcblxuICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgICAgICAgICAgbmF0aXZlSW5wdXQuc2V0U2VsZWN0aW9uUmFuZ2UoY2FyZXQsIGNhcmV0KTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKFxuICAgICAgICAgICAgbmF0aXZlSW5wdXQgJiZcbiAgICAgICAgICAgIG5hdGl2ZUlucHV0Lm93bmVyRG9jdW1lbnQgIT09IGdldERvY3VtZW50T3JTaGFkb3dSb290KG5hdGl2ZUlucHV0KSAmJlxuICAgICAgICAgICAgaXNOYXRpdmVGb2N1c2VkKG5hdGl2ZUlucHV0KSAmJlxuICAgICAgICAgICAgY29uZmlnLmN1cnJlbnRDYXJldFBvc2l0aW9uXG4gICAgICAgICkge1xuICAgICAgICAgICAgY29uc3QgcmVhbENhcmV0UG9zaXRpb24gPVxuICAgICAgICAgICAgICAgIGNvbmZpZy5jdXJyZW50Q2FyZXRQb3NpdGlvbiArXG4gICAgICAgICAgICAgICAgY2FsY3VsYXRlQ2FyZXRHYXAoY29uZmlnLnByZXZpb3VzQ29uZm9ybWVkVmFsdWUsIGNvbmZvcm1lZFZhbHVlKTtcblxuICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgICAgICAgICAgbmF0aXZlSW5wdXQuc2V0U2VsZWN0aW9uUmFuZ2UocmVhbENhcmV0UG9zaXRpb24sIHJlYWxDYXJldFBvc2l0aW9uKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGNvbmZvcm1lZFZhbHVlID09PSAnJyB8fCAhZGVjaW1hbExpbWl0KSB7XG4gICAgICAgICAgICByZXR1cm4ge3ZhbHVlOiBjb25mb3JtZWRWYWx1ZX07XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCB3aXRoRGVjaW1hbFN5bWJvbCA9IGFkZERlY2ltYWxTeW1ib2xJZk5lZWRlZChjb25mb3JtZWRWYWx1ZSwgZGVjaW1hbFN5bWJvbCk7XG4gICAgICAgIGNvbnN0IGRlY2ltYWxQYXJ0ID0gd2l0aERlY2ltYWxTeW1ib2wuc3BsaXQoZGVjaW1hbFN5bWJvbClbMV07XG4gICAgICAgIGNvbnN0IHplcm9QYWRkaW5nU2l6ZSA9IGRlY2ltYWxMaW1pdCAtIGRlY2ltYWxQYXJ0Lmxlbmd0aDtcblxuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgdmFsdWU6IHdpdGhEZWNpbWFsU3ltYm9sICsgJzAnLnJlcGVhdCh6ZXJvUGFkZGluZ1NpemUpLFxuICAgICAgICB9O1xuICAgIH07XG59XG5cbmZ1bmN0aW9uIGFkZERlY2ltYWxTeW1ib2xJZk5lZWRlZChcbiAgICB2YWx1ZTogc3RyaW5nLFxuICAgIGRlY2ltYWxTeW1ib2w6IFR1aURlY2ltYWxTeW1ib2wgPSAnLCcsXG4pOiBzdHJpbmcge1xuICAgIHJldHVybiB2YWx1ZS5pbmRleE9mKGRlY2ltYWxTeW1ib2wpID09PSAtMSA/IHZhbHVlICsgZGVjaW1hbFN5bWJvbCA6IHZhbHVlO1xufVxuXG5mdW5jdGlvbiBjYWxjdWxhdGVTYWZhcmlDYXJldChcbiAgICBwcmV2aW91c1ZhbHVlOiBzdHJpbmcgPSAnJyxcbiAgICBjdXJyZW50OiBzdHJpbmcsXG4gICAgcHJldmlvdXNDYXJldDogbnVtYmVyLFxuICAgIGRlY2ltYWxTeW1ib2w6IHN0cmluZyA9ICcsJyxcbik6IG51bWJlciB7XG4gICAgY29uc3QgdGFpbFJlZ2V4ID0gbmV3IFJlZ0V4cChgJHtkZWNpbWFsU3ltYm9sfS4rYCk7XG4gICAgY29uc3QgcHJldmlvdXNXaXRob3V0VGFpbCA9IHByZXZpb3VzVmFsdWUucmVwbGFjZSh0YWlsUmVnZXgsICcnKTtcbiAgICBjb25zdCBjdXJyZW50V2l0aG91dFRhaWwgPSBjdXJyZW50LnJlcGxhY2UodGFpbFJlZ2V4LCAnJyk7XG5cbiAgICBjb25zdCBwYXN0ZU9yQ3V0T3BlcmF0aW9uID1cbiAgICAgICAgTWF0aC5hYnMocHJldmlvdXNXaXRob3V0VGFpbC5sZW5ndGggLSBjdXJyZW50V2l0aG91dFRhaWwubGVuZ3RoKSA+IDI7XG5cbiAgICBpZiAocGFzdGVPckN1dE9wZXJhdGlvbikge1xuICAgICAgICByZXR1cm4gY3VycmVudC5sZW5ndGg7XG4gICAgfVxuXG4gICAgaWYgKHByZXZpb3VzVmFsdWUubGVuZ3RoID09PSBjdXJyZW50Lmxlbmd0aCkge1xuICAgICAgICBpZiAocHJldmlvdXNWYWx1ZS5pbmRleE9mKGRlY2ltYWxTeW1ib2wpIDw9IHByZXZpb3VzQ2FyZXQpIHtcbiAgICAgICAgICAgIHJldHVybiBjYWxjdWxhdGVDaGFuZ2VkVGFpbEluZGV4KHByZXZpb3VzVmFsdWUsIGN1cnJlbnQpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHByZXZpb3VzV2l0aG91dFRhaWwgPT09IGN1cnJlbnRXaXRob3V0VGFpbFxuICAgICAgICAgICAgPyBwcmV2aW91c0NhcmV0IC0gMVxuICAgICAgICAgICAgOiBwcmV2aW91c0NhcmV0ICsgMTtcbiAgICB9XG5cbiAgICBpZiAocHJldmlvdXNWYWx1ZS5sZW5ndGggPT09IDApIHtcbiAgICAgICAgcmV0dXJuIDE7XG4gICAgfVxuXG4gICAgY29uc3QgY2hhbmdlTGVuZ3RoID0gY3VycmVudC5sZW5ndGggLSBwcmV2aW91c1ZhbHVlLmxlbmd0aDtcblxuICAgIHJldHVybiBwcmV2aW91c0NhcmV0ICsgY2hhbmdlTGVuZ3RoO1xufVxuXG5mdW5jdGlvbiBjYWxjdWxhdGVDaGFuZ2VkVGFpbEluZGV4KHByZXZpb3VzOiBzdHJpbmcsIGN1cnJlbnQ6IHN0cmluZyk6IG51bWJlciB7XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjdXJyZW50Lmxlbmd0aDsgaSsrKSB7XG4gICAgICAgIGlmIChwcmV2aW91c1tpXSAhPT0gY3VycmVudFtpXSkge1xuICAgICAgICAgICAgcmV0dXJuIGN1cnJlbnRbaV0gPT09ICcwJyA/IGkgOiBpICsgMTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiBjdXJyZW50Lmxlbmd0aDtcbn1cblxuZnVuY3Rpb24gY2FsY3VsYXRlQ2FyZXRHYXAocHJldmlvdXNWYWx1ZTogc3RyaW5nID0gJycsIGN1cnJlbnQ6IHN0cmluZyk6IG51bWJlciB7XG4gICAgY29uc3QgcGFzdGVPckN1dE9wZXJhdGlvbiA9IE1hdGguYWJzKHByZXZpb3VzVmFsdWUubGVuZ3RoIC0gY3VycmVudC5sZW5ndGgpID4gMjtcblxuICAgIGlmIChwYXN0ZU9yQ3V0T3BlcmF0aW9uKSB7XG4gICAgICAgIHJldHVybiAwO1xuICAgIH1cblxuICAgIGNvbnN0IHdlcmVTcGFjZXMgPSBwcmV2aW91c1ZhbHVlLnNwbGl0KENIQVJfTk9fQlJFQUtfU1BBQ0UpLmxlbmd0aDtcbiAgICBjb25zdCBub3dTcGFjZXMgPSBjdXJyZW50LnNwbGl0KENIQVJfTk9fQlJFQUtfU1BBQ0UpLmxlbmd0aDtcblxuICAgIHJldHVybiBub3dTcGFjZXMgLSB3ZXJlU3BhY2VzO1xufVxuIl19